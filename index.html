<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="My Planner"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>My Planner ğŸŒ¿</title>

  <!-- PWA ì•„ì´ì½˜ (í™ˆ í™”ë©´ ì¶”ê°€ìš©) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%232DB87A'/><text y='.9em' font-size='72' x='12'>ğŸŒ¿</text></svg>"/>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background: linear-gradient(135deg, #E8F5EF, #F5F9FF);
      overscroll-behavior: none;
    }
    input, textarea, select, button {
      font-family: inherit;
    }
    /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    ::-webkit-scrollbar { display: none; }
    scrollbar-width: none;
    /* ì•„ì´í° ì•ˆì „ì˜ì—­ */
    #root {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel (CDN) -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

  <!-- Storage Polyfill -->
  <script>

// â”€â”€ Storage Polyfill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Claude.ai í™˜ê²½: window.storage ì‚¬ìš© (shared:true â†’ ê¸°ê¸°ê°„ ë™ê¸°í™”)
// ë¡œì»¬ í™˜ê²½(íŒŒì¼ ì§ì ‘ ì—´ê¸°): localStorage í´ë°± ì‚¬ìš©
if (!window.storage) {
  const PREFIX = 'myplanner:';
  window.storage = {
    get: async (key, shared) => {
      const k = (shared ? 'shared:' : '') + PREFIX + key;
      const v = localStorage.getItem(k);
      return v ? { key, value: v, shared: !!shared } : null;
    },
    set: async (key, value, shared) => {
      const k = (shared ? 'shared:' : '') + PREFIX + key;
      localStorage.setItem(k, value);
      // BroadcastChannelìœ¼ë¡œ ê°™ì€ ë¸Œë¼ìš°ì € ë‚´ íƒ­/ì°½ ê°„ ì‹¤ì‹œê°„ ë™ê¸°í™”
      try {
        const bc = new BroadcastChannel('myplanner-sync');
        bc.postMessage({ key, value, shared });
        bc.close();
      } catch(e) {}
      return { key, value, shared: !!shared };
    },
    delete: async (key, shared) => {
      const k = (shared ? 'shared:' : '') + PREFIX + key;
      localStorage.removeItem(k);
      return { key, deleted: true, shared: !!shared };
    },
    list: async (prefix, shared) => {
      const p = (shared ? 'shared:' : '') + PREFIX + (prefix || '');
      const keys = Object.keys(localStorage).filter(k => k.startsWith(p))
        .map(k => k.replace((shared ? 'shared:' : '') + PREFIX, ''));
      return { keys, prefix, shared: !!shared };
    },
  };
  // ê°™ì€ ë¸Œë¼ìš°ì € ë‹¤ë¥¸ íƒ­ì—ì„œ ë³€ê²½ ì‹œ ìë™ ë°˜ì˜
  try {
    const bc = new BroadcastChannel('myplanner-sync');
    bc.onmessage = () => {
      document.dispatchEvent(new Event('visibilitychange'));
    };
  } catch(e) {}
}

  </script>

  <!-- App -->
  <script type="text/babel" data-presets="react">
const { useState, useEffect, useRef, useCallback } = React;


// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const G = {
  green: "#2DB87A", greenDark: "#1E9E63", greenSoft: "#E8F8F1", greenMid: "#C5EDD9",
  red: "#F05252", blue: "#4A90E2", yellow: "#F5A623",
  text: "#1A202C", textMid: "#4A5568", textLight: "#94A3B8",
  bg: "#F8FAFB", card: "#ffffff", border: "#E2E8F0", borderLight: "#F0F4F8",
};

const ds = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const getDays = (y,m) => new Date(y,m+1,0).getDate();
const getFirst = (y,m) => new Date(y,m,1).getDay();
const getWeekDates = d => {
  const b = new Date(d); b.setDate(b.getDate()-b.getDay());
  return Array.from({length:7},(_,i)=>{ const n=new Date(b); n.setDate(b.getDate()+i); return n; });
};
const getWeekKey = d => ds(getWeekDates(d)[0]);
const HOURS = Array.from({length:24},(_,i)=>i);
const DAYS_KO = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
const MONTHS_KO = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
const TODAY = new Date(2026,1,19);
const TODAY_STR = ds(TODAY);
const PALETTE = ["#FF6B6B","#4A90E2","#F5A623","#2DB87A","#A855F7","#EC4899","#14B8A6","#F97316"];

function getWeekOfMonth(date) {
  const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  return Math.ceil((date.getDate() + firstDay) / 7);
}
const KO_ORDINALS = ["ì²«","ë‘˜","ì…‹","ë„·","ë‹¤ì„¯","ì—¬ì„¯"];
function weekOrdinalKo(n){ return (KO_ORDINALS[n-1]||n)+"ì§¸"; }

const WORKOUT_TYPES = ["í—¬ìŠ¤/ì›¨ì´íŠ¸","ëŸ¬ë‹","ìˆ˜ì˜","ìì „ê±°","í•„ë¼í…ŒìŠ¤","ìš”ê°€","í´ë¼ì´ë°","HIIT","ìŠ¤íŠ¸ë ˆì¹­","ê¸°íƒ€"];
const DEFAULT_MEAL_CATS = [
  { id:"breakfast", label:"ì•„ì¹¨", icon:"ğŸŒ…" },
  { id:"lunch",     label:"ì ì‹¬", icon:"â˜€ï¸" },
  { id:"dinner",    label:"ì €ë…", icon:"ğŸŒ™" },
  { id:"snack",     label:"ê°„ì‹", icon:"ğŸ" },
];
const DEFAULT_WEIGHT_LOG = {
  "2026-02-10": 68.5, "2026-02-11": 68.3, "2026-02-12": 68.6,
  "2026-02-13": 68.1, "2026-02-14": 68.0, "2026-02-15": 67.8,
  "2026-02-16": 67.9, "2026-02-17": 67.5, "2026-02-18": 67.4,
  "2026-02-19": 67.2,
};
const DEFAULT_DIET_LOG = {
  "2026-02-19": [
    { id:1, meal:"breakfast", foods:"ì˜¤íŠ¸ë°€, ë°”ë‚˜ë‚˜, ì•„ëª¬ë“œë°€í¬" },
    { id:2, meal:"lunch",     foods:"ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ, í†µë°€ë¹µ" },
    { id:3, meal:"dinner",    foods:"í˜„ë¯¸ë°¥, ëœì¥ì°Œê°œ, ë‚˜ë¬¼ë°˜ì°¬" },
  ],
};
const DEFAULT_WORKOUT_LOG = {
  "2026-02-17": [{ id:1, type:"í—¬ìŠ¤/ì›¨ì´íŠ¸", duration:60, note:"ë“± ë°ì´", sets:[{exercise:"í’€ì—…",reps:"10x3",weight:""},{exercise:"ë ›í’€ë‹¤ìš´",reps:"12x4",weight:"60kg"},{exercise:"ì‹œí‹°ë“œë¡œìš°",reps:"12x4",weight:"55kg"}] }],
  "2026-02-18": [{ id:2, type:"ëŸ¬ë‹", duration:30, note:"5.2km", sets:[] }],
  "2026-02-19": [{ id:3, type:"í—¬ìŠ¤/ì›¨ì´íŠ¸", duration:70, note:"ê°€ìŠ´/ì–´ê¹¨ ë°ì´", sets:[{exercise:"ë²¤ì¹˜í”„ë ˆìŠ¤",reps:"10x4",weight:"70kg"},{exercise:"ì¸í´ë¼ì¸",reps:"12x3",weight:"60kg"},{exercise:"ìˆ„ë”í”„ë ˆìŠ¤",reps:"12x3",weight:"40kg"}] }],
};

const DEFAULT_CATS = [
  { id:"adp",     label:"ADP ìê²©ì¦", color:"#FF6B6B", icon:"ğŸ“˜" },
  { id:"english", label:"ì˜ì–´ ê³µë¶€",   color:"#4A90E2", icon:"ğŸ—£ï¸" },
  { id:"job",     label:"ì´ì§ ì¤€ë¹„",   color:"#F5A623", icon:"ğŸ’¼" },
];
const DEFAULT_TB = {
  "2026-02-19":[
    {id:1,title:"ADP ê³µë¶€",    start:9, end:11,color:"#FF6B6B",catId:"adp"},
    {id:2,title:"ì˜ì–´ ë‹¨ì–´",   start:7, end:8, color:"#4A90E2",catId:"english"},
    {id:3,title:"ì´ì§ ì´ë ¥ì„œ", start:14,end:16,color:"#F5A623",catId:"job"},
    {id:4,title:"ì ì‹¬",        start:12,end:13,color:"#A0AEC0",catId:null},
  ],
  "2026-02-20":[{id:5,title:"ìŠ¤í„°ë””",start:10,end:12,color:"#FF6B6B",catId:"adp"}],
  "2026-02-25":[
    {id:6,title:"ëª¨ì˜ì‹œí—˜",start:9,end:12,color:"#FF6B6B",catId:"adp"},
    {id:7,title:"ì˜ì–´ ë¦¬ë”©",start:14,end:15,color:"#4A90E2",catId:"english"},
  ],
};
const DEFAULT_TASKS = {
  "2026-02-19":[
    {id:1,title:"ADP 1~30P",done:false,priority:"high",  catId:"adp",    auto:true, time:"09:00"},
    {id:2,title:"ì˜ì–´ ë‹¨ì–´ 50ê°œ",done:true,priority:"medium",catId:"english",auto:true, time:"07:00"},
    {id:3,title:"ìì†Œì„œ 1ë¬¸í•­",done:false,priority:"high", catId:"job",    auto:true, time:"14:00"},
    {id:4,title:"ì´ë©”ì¼ í™•ì¸",done:false,priority:"low",  catId:null,     auto:false,time:""},
  ],
};
const WEEK_KEY = getWeekKey(TODAY);
const DEFAULT_WG = {
  [WEEK_KEY]:[
    {id:1,catId:"adp",    title:"ADP 1~150P ê³µë¶€",  activeDays:[1,2,3,4,5],retro:"",
     chunks:[{day:1,desc:"1~30P"},{day:2,desc:"31~60P"},{day:3,desc:"61~90P"},{day:4,desc:"91~120P"},{day:5,desc:"121~150P"}]},
    {id:2,catId:"english",title:"ì˜ì–´ ë‹¨ì–´ 350ê°œ",   activeDays:[1,2,3,4,5],retro:"",
     chunks:[{day:1,desc:"1~70"},{day:2,desc:"71~140"},{day:3,desc:"141~210"},{day:4,desc:"211~280"},{day:5,desc:"281~350"}]},
    {id:3,catId:"job",    title:"ìì†Œì„œ 3ë¬¸í•­ ì™„ì„±", activeDays:[1,2,3,4,5],retro:"",
     chunks:[{day:1,desc:"1ë¬¸í•­"},{day:2,desc:"2ë¬¸í•­"},{day:3,desc:"3ë¬¸í•­ ì´ˆì•ˆ"},{day:4,desc:"ìˆ˜ì •"},{day:5,desc:"ìµœì¢…"}]},
  ],
};
function parsePages(rangeStr) {
  if (!rangeStr || !rangeStr.trim()) return 0;
  const s = rangeStr.trim().replace(/\s/g, "");
  const rangeMatch = s.match(/[Pp]?(\d+)[~\-\u2013][Pp]?(\d+)/);
  if (rangeMatch) { const a = parseInt(rangeMatch[1],10); const b = parseInt(rangeMatch[2],10); return Math.abs(b-a)+1; }
  const single = s.match(/^[Pp]?(\d+)$/);
  if (single) return parseInt(single[1],10);
  return 0;
}
const DEFAULT_READING = {
  "2026-02-17":{ bookTitle:"ì•„ëª¬ë“œ", pageRange:"P1~P42",   pages:42 },
  "2026-02-18":{ bookTitle:"ì•„ëª¬ë“œ", pageRange:"P43~P100", pages:58 },
  "2026-02-19":{ bookTitle:"ì•„ëª¬ë“œ", pageRange:"P101~P135",pages:35 },
};

const DEFAULT_HABITS = [
  { id:"h1", title:"ì•„ì¹¨ ê¸°ìƒ (7ì‹œ)", icon:"â˜€ï¸", color:"#F5A623", targetDays:[1,2,3,4,5] },
  { id:"h2", title:"ìš´ë™ 30ë¶„",       icon:"ğŸ’ª", color:"#F05252", targetDays:[1,2,3,4,5,6,0] },
  { id:"h3", title:"ì˜ì–´ ë‹¨ì–´ 50ê°œ",  icon:"ğŸ“", color:"#4A90E2", targetDays:[1,2,3,4,5] },
  { id:"h4", title:"ë…ì„œ 30ë¶„",       icon:"ğŸ“–", color:"#2DB87A", targetDays:[1,2,3,4,5,6,0] },
  { id:"h5", title:"ë¬¼ 2L ë§ˆì‹œê¸°",    icon:"ğŸ’§", color:"#14B8A6", targetDays:[1,2,3,4,5,6,0] },
];
const DEFAULT_HABIT_LOG = {
  "2026-02-16":{ h1:true,  h2:true,  h3:true,  h4:false, h5:true  },
  "2026-02-17":{ h1:true,  h2:false, h3:true,  h4:true,  h5:true  },
  "2026-02-18":{ h1:true,  h2:true,  h3:true,  h4:true,  h5:false },
  "2026-02-19":{ h1:true,  h2:false, h3:true,  h4:false, h5:true  },
};

const BUDGET_EXPENSE_CATS = ["ì‹ë¹„","êµí†µ","ì¹´í˜","ì‡¼í•‘","ì˜ë£Œ","ë¬¸í™”","êµ¬ë…","ê¸°íƒ€"];
const BUDGET_INCOME_CATS  = ["ê¸‰ì—¬","ë¶€ì—…","ìš©ëˆ","íˆ¬ììˆ˜ìµ","ê¸°íƒ€"];
const DEFAULT_BUDGET = {
  "2026-02-17":[
    { id:1, type:"expense", amount:12000, category:"ì‹ë¹„",   note:"ì ì‹¬" },
    { id:2, type:"expense", amount:5500,  category:"êµí†µ",   note:"ì§€í•˜ì² " },
    { id:3, type:"expense", amount:6000,  category:"ì¹´í˜",   note:"ì•„ë©”ë¦¬ì¹´ë…¸" },
  ],
  "2026-02-18":[
    { id:4, type:"expense", amount:18000, category:"ì‹ë¹„",   note:"ì €ë… ì™¸ì‹" },
    { id:5, type:"income",  amount:50000, category:"ìš©ëˆ",   note:"" },
  ],
  "2026-02-19":[
    { id:6, type:"expense", amount:9500,  category:"ì‹ë¹„",   note:"ì ì‹¬" },
    { id:7, type:"expense", amount:4400,  category:"êµí†µ",   note:"ë²„ìŠ¤" },
    { id:8, type:"income",  amount:3200000,category:"ê¸‰ì—¬",  note:"2ì›” ê¸‰ì—¬" },
  ],
};

function usePersist(key, defaultVal) {
  const [val, setVal] = useState(defaultVal);
  const localSnapshot = useRef(null);
  const isMounted = useRef(true);

  const fetchRemote = useCallback(async () => {
    try {
      if (!window.storage || typeof window.storage.get !== "function") return;
      const res = await window.storage.get(key, true);
      if (!isMounted.current) return;
      if (res && res.value) {
        const parsed = JSON.parse(res.value);
        if (localSnapshot.current === null || JSON.stringify(parsed) !== localSnapshot.current) {
          localSnapshot.current = res.value;
          setVal(parsed);
        }
      }
    } catch(_) {}
  }, [key]);

  useEffect(() => {
    isMounted.current = true;
    fetchRemote();
    const poll = setInterval(fetchRemote, 30000);
    const onFocus = () => fetchRemote();
    const onVisible = () => { if (document.visibilityState === "visible") fetchRemote(); };
    window.addEventListener("focus", onFocus);
    document.addEventListener("visibilitychange", onVisible);
    return () => {
      isMounted.current = false;
      clearInterval(poll);
      window.removeEventListener("focus", onFocus);
      document.removeEventListener("visibilitychange", onVisible);
    };
  }, [fetchRemote]);

  const save = useCallback((updater) => {
    setVal(prev => {
      const next = typeof updater === "function" ? updater(prev) : updater;
      const serialized = JSON.stringify(next);
      localSnapshot.current = serialized;
      try {
        if (window.storage && typeof window.storage.set === "function")
          window.storage.set(key, serialized, true).catch(()=>{});
      } catch(_) {}
      return next;
    });
  }, [key]);

  return [val, save];
}

const inp = (extra={}) => ({
  width:"100%", background:"#F7F9FC", border:`1.5px solid ${G.border}`,
  borderRadius:12, padding:"12px 14px", color:G.text, fontSize:14,
  outline:"none", boxSizing:"border-box", marginBottom:12, fontFamily:"inherit", ...extra,
});
const selStyle = {
  width:"100%", background:"#F7F9FC", border:`1.5px solid ${G.border}`,
  borderRadius:12, padding:"10px 12px", color:G.text, fontSize:13, outline:"none",
};
const navBtnStyle = {
  width:34,height:34,borderRadius:10,background:"#F0F4F8",border:"none",
  cursor:"pointer",color:G.textMid,fontSize:18,display:"flex",alignItems:"center",justifyContent:"center",padding:0,
};

function Btn({children, onClick, variant="primary", style={}, small=false}){
  const base = {
    border:"none", cursor:"pointer", borderRadius:small?10:14,
    padding: small?"6px 12px":"13px 0",
    fontSize: small?11:14, fontWeight:700, transition:"all 0.18s",
    display:"inline-flex", alignItems:"center", justifyContent:"center", gap:5,
  };
  const variants = {
    primary:  { background:G.green, color:"#fff", boxShadow:`0 4px 14px ${G.green}44` },
    ghost:    { background:G.greenSoft, color:G.green, border:`1.5px solid ${G.greenMid}` },
    danger:   { background:"#FFF5F5", color:G.red, border:`1.5px solid #FEB2B2` },
    neutral:  { background:"#F0F4F8", color:G.textMid },
    pill:     { background:"transparent", border:`1.5px solid ${G.border}`, color:G.textLight },
  };
  return <button onClick={onClick} style={{...base,...variants[variant],...style}}>{children}</button>;
}

function CatBadge({ catId, cats, small }){
  const c = cats.find(x=>x.id===catId);
  if(!c) return null;
  return (
    <span style={{display:"inline-flex",alignItems:"center",gap:3,padding:small?"2px 7px":"3px 9px",
      borderRadius:20,fontSize:small?9:10,fontWeight:700,background:`${c.color}18`,color:c.color}}>
      {c.icon} {c.label}
    </span>
  );
}

function Modal({ show, onClose, title, children }){
  if(!show) return null;
  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"flex-end",backdropFilter:"blur(8px)",zIndex:200}} onClick={onClose}>
      <div onClick={e=>e.stopPropagation()} style={{width:"100%",background:"#fff",borderRadius:"24px 24px 0 0",padding:24,paddingBottom:40,
        maxHeight:"88vh",overflowY:"auto",boxShadow:"0 -8px 40px rgba(0,0,0,0.1)"}}>
        <div style={{width:36,height:4,background:G.border,borderRadius:2,margin:"0 auto 16px"}}/>
        {title && <div style={{color:G.text,fontSize:17,fontWeight:800,marginBottom:16}}>{title}</div>}
        {children}
      </div>
    </div>
  );
}

function CatsManager({ cats, setCats, onClose }){
  const [editCat, setEditCat] = useState(null);
  const [form, setForm] = useState({label:"",icon:"ğŸ“Œ",color:PALETTE[0]});
  function openAdd(){ setEditCat(null); setForm({label:"",icon:"ğŸ“Œ",color:PALETTE[0]}); }
  function openEdit(c){ setEditCat(c.id); setForm({label:c.label,icon:c.icon,color:c.color}); }
  function save(){
    if(!form.label.trim()) return;
    if(editCat){ setCats(p=>p.map(c=>c.id===editCat?{...c,...form}:c)); }
    else { setCats(p=>[...p,{id:`cat_${Date.now()}`,label:form.label,icon:form.icon,color:form.color}]); }
    setEditCat(null); setForm({label:"",icon:"ğŸ“Œ",color:PALETTE[0]});
  }
  function del(id){ setCats(p=>p.filter(c=>c.id!==id)); }
  return (
    <div>
      <div style={{color:G.text,fontSize:17,fontWeight:800,marginBottom:4}}>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
      <div style={{fontSize:11,color:G.textLight,marginBottom:16}}>ì›”ê°„ Â· ì£¼ê°„ Â· ì¼ê°„ ì „ì²´ì— ì ìš©ë©ë‹ˆë‹¤</div>
      {cats.map(c=>(
        <div key={c.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 0",borderBottom:`1px solid ${G.borderLight}`}}>
          <div style={{width:36,height:36,borderRadius:10,background:`${c.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>{c.icon}</div>
          <div style={{flex:1}}>
            <div style={{fontWeight:700,color:G.text,fontSize:13}}>{c.label}</div>
            <div style={{width:40,height:4,borderRadius:2,background:c.color,marginTop:3}}/>
          </div>
          <Btn small variant="neutral" onClick={()=>openEdit(c)}>âœï¸ ìˆ˜ì •</Btn>
          <Btn small variant="danger" onClick={()=>del(c.id)}>ì‚­ì œ</Btn>
        </div>
      ))}
      <div style={{marginTop:16,padding:16,background:G.bg,borderRadius:16,border:`1.5px solid ${G.border}`}}>
        <div style={{color:G.textLight,fontSize:11,fontWeight:700,letterSpacing:1,marginBottom:10}}>{editCat?"ì¹´í…Œê³ ë¦¬ ìˆ˜ì •":"ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€"}</div>
        <div style={{display:"flex",gap:8,marginBottom:10}}>
          <input value={form.icon} onChange={e=>setForm(f=>({...f,icon:e.target.value}))}
            style={{...inp(),width:56,marginBottom:0,textAlign:"center",fontSize:20,padding:"8px"}} placeholder="ğŸ·ï¸" maxLength={2}/>
          <input value={form.label} onChange={e=>setForm(f=>({...f,label:e.target.value}))}
            style={{...inp(),flex:1,marginBottom:0}} placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„"/>
        </div>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:12}}>
          {PALETTE.map(clr=>(
            <div key={clr} onClick={()=>setForm(f=>({...f,color:clr}))}
              style={{width:26,height:26,borderRadius:13,background:clr,cursor:"pointer",
                boxShadow:form.color===clr?`0 0 0 3px white, 0 0 0 5px ${clr}`:"none",transition:"all 0.15s"}}/>
          ))}
        </div>
        <Btn variant="primary" style={{width:"100%"}} onClick={save}>{editCat?"ìˆ˜ì • ì €ì¥":"ì¶”ê°€"}</Btn>
        {editCat && <Btn variant="neutral" style={{width:"100%",marginTop:8}} onClick={()=>{ setEditCat(null); setForm({label:"",icon:"ğŸ“Œ",color:PALETTE[0]}); }}>ì·¨ì†Œ</Btn>}
      </div>
      <Btn variant="ghost" style={{width:"100%",marginTop:12}} onClick={onClose}>ë‹«ê¸°</Btn>
    </div>
  );
}

function ReadingLogEntry({ dateStr, readingLog, setReadingLog }){
  const entry = readingLog[dateStr] || { bookTitle:"", pageRange:"", pages:0 };
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState({bookTitle:"", pageRange:""});
  const calcPages = parsePages(form.pageRange);
  function startEdit(){ setForm({ bookTitle: entry.bookTitle||"", pageRange: entry.pageRange||"" }); setEditing(true); }
  function save(){
    if(!form.bookTitle.trim()) { setEditing(false); return; }
    const pages = parsePages(form.pageRange);
    setReadingLog(p=>({...p,[dateStr]:{ bookTitle:form.bookTitle, pageRange:form.pageRange, pages }}));
    setEditing(false);
  }
  if(!editing && !entry.bookTitle) return (
    <button onClick={startEdit} style={{width:"100%",padding:"10px 0",borderRadius:12,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:12,fontWeight:700,cursor:"pointer",marginTop:8}}>ğŸ“– ë…ì„œ ê¸°ë¡ ì¶”ê°€</button>
  );
  if(!editing) return (
    <div onClick={startEdit} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",background:G.greenSoft,borderRadius:12,marginTop:8,cursor:"pointer",border:`1.5px solid ${G.greenMid}`}}>
      <span style={{fontSize:20}}>ğŸ“–</span>
      <div style={{flex:1}}>
        <div style={{fontSize:13,fontWeight:700,color:G.greenDark}}>{entry.bookTitle}</div>
        <div style={{display:"flex",gap:6,marginTop:2,alignItems:"center"}}>
          {entry.pageRange && <span style={{fontSize:11,color:G.textMid}}>{entry.pageRange}</span>}
          <span style={{fontSize:11,color:G.green,fontWeight:700}}>{entry.pages}p ì½ìŒ</span>
        </div>
      </div>
      <span style={{fontSize:11,color:G.textLight}}>ìˆ˜ì •</span>
    </div>
  );
  return (
    <div style={{padding:14,background:G.greenSoft,borderRadius:14,marginTop:8,border:`1.5px solid ${G.greenMid}`}}>
      <div style={{color:G.greenDark,fontSize:11,fontWeight:800,letterSpacing:1,marginBottom:8}}>ğŸ“– ë…ì„œ ê¸°ë¡</div>
      <input value={form.bookTitle} onChange={e=>setForm(f=>({...f,bookTitle:e.target.value}))} placeholder="ì±… ì œëª©" style={{...inp(),marginBottom:8,fontSize:13}}/>
      <div style={{position:"relative",marginBottom:8}}>
        <input value={form.pageRange} onChange={e=>setForm(f=>({...f,pageRange:e.target.value}))}
          placeholder="í˜ì´ì§€ ë²”ìœ„ (ì˜ˆ: P1~P50)" style={{...inp(),marginBottom:0,fontSize:13,paddingRight:72}}/>
        {form.pageRange.trim() && (
          <div style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",
            background:G.green,color:"#fff",borderRadius:8,padding:"3px 8px",fontSize:11,fontWeight:700,pointerEvents:"none"}}>{calcPages}p</div>
        )}
      </div>
      <div style={{display:"flex",gap:8}}>
        <Btn variant="primary" small style={{flex:1,padding:"10px 0"}} onClick={save}>ì €ì¥</Btn>
        <Btn variant="neutral" small style={{flex:1,padding:"10px 0"}} onClick={()=>setEditing(false)}>ì·¨ì†Œ</Btn>
        {entry.bookTitle && <Btn variant="danger" small style={{padding:"10px 14px"}} onClick={()=>{setReadingLog(p=>{const n={...p};delete n[dateStr];return n;});setEditing(false);}}>ì‚­ì œ</Btn>}
      </div>
    </div>
  );
}

function DayPopup({ selectedDate, dayBlocks, tasks, selStr, readingLog, cats,
  showTimeline, setShowTimeline, onClose, openEdit, openAdd,
  setTimeblocks, gridRef, onMove, setDragInfo, startDrag }) {
  const HOUR_PX = 56;
  const [cardDrag, setCardDrag] = useState(null);
  const [movePicker, setMovePicker] = useState(null);
  const [pickerMonth, setPickerMonth] = useState({ y: selectedDate.getFullYear(), m: selectedDate.getMonth() });

  function onCardMouseDown(e, b) { e.preventDefault(); e.stopPropagation(); setCardDrag({ id:b.id, startY:e.clientY, origStart:b.start, origEnd:b.end, currentStart:b.start }); }
  function onCardTouchStart(e, b) { e.stopPropagation(); const t=e.touches[0]; setCardDrag({ id:b.id, startY:t.clientY, origStart:b.start, origEnd:b.end, currentStart:b.start }); }
  function onGlobalMove(e) {
    if (!cardDrag) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const dh = Math.round((clientY - cardDrag.startY) / HOUR_PX);
    const dur = cardDrag.origEnd - cardDrag.origStart;
    const ns = Math.max(0, Math.min(24-dur, cardDrag.origStart + dh));
    if (ns !== cardDrag.currentStart) {
      setCardDrag(d => ({...d, currentStart:ns}));
      setTimeblocks(prev => {
        const bl = [...(prev[selStr]||[])];
        const i = bl.findIndex(b => b.id === cardDrag.id);
        if (i < 0) return prev;
        bl[i] = {...bl[i], start:ns, end:ns+(cardDrag.origEnd-cardDrag.origStart)};
        return {...prev, [selStr]:bl};
      });
    }
  }
  function onGlobalUp() { setCardDrag(null); }
  function openDatePicker(e, blockId) { e.stopPropagation(); setMovePicker(blockId); setPickerMonth({ y: selectedDate.getFullYear(), m: selectedDate.getMonth() }); }
  function moveToDate(targetDateStr) {
    if (targetDateStr === selStr) { setMovePicker(null); return; }
    setTimeblocks(prev => {
      const srcBlocks = [...(prev[selStr]||[])];
      const idx = srcBlocks.findIndex(b => b.id === movePicker);
      if (idx < 0) return prev;
      const block = srcBlocks[idx];
      const newSrc = srcBlocks.filter((_,i) => i !== idx);
      const newDst = [...(prev[targetDateStr]||[]), {...block}];
      return {...prev, [selStr]: newSrc, [targetDateStr]: newDst};
    });
    setMovePicker(null);
  }

  const isDraggingId = cardDrag?.id;

  function MiniCalPicker() {
    const { y, m } = pickerMonth;
    const firstDay = getFirst(y, m);
    const totalDays = getDays(y, m);
    return (
      <div onClick={e=>e.stopPropagation()} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",backdropFilter:"blur(4px)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center"}}>
        <div style={{background:"#fff",borderRadius:24,padding:24,width:320,boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <button onClick={()=>setPickerMonth(p=>({y:p.m===0?p.y-1:p.y,m:p.m===0?11:p.m-1}))} style={{width:32,height:32,borderRadius:10,background:"#F0F4F8",border:"none",cursor:"pointer",fontSize:16,color:G.textMid}}>â€¹</button>
            <span style={{fontWeight:800,fontSize:15,color:G.text}}>{y}ë…„ {MONTHS_KO[m]}</span>
            <button onClick={()=>setPickerMonth(p=>({y:p.m===11?p.y+1:p.y,m:p.m===11?0:p.m+1}))} style={{width:32,height:32,borderRadius:10,background:"#F0F4F8",border:"none",cursor:"pointer",fontSize:16,color:G.textMid}}>â€º</button>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",marginBottom:4}}>
            {DAYS_KO.map((d,i)=>(<div key={d} style={{textAlign:"center",fontSize:10,fontWeight:700,color:i===0?G.red:i===6?G.blue:G.textLight,paddingBottom:4}}>{d}</div>))}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2}}>
            {Array.from({length:firstDay}).map((_,i)=><div key={`e${i}`}/>)}
            {Array.from({length:totalDays},(_,i)=>{
              const day=i+1;
              const tStr=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
              const isCur=tStr===selStr; const isTd=tStr===TODAY_STR; const dow=new Date(y,m,day).getDay();
              return (
                <div key={day} onClick={()=>moveToDate(tStr)} style={{width:36,height:36,borderRadius:18,margin:"1px auto",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",
                  background:isCur?"#EDF2F7":isTd?G.green:"transparent",color:isTd?"#fff":isCur?G.textLight:dow===0?G.red:dow===6?G.blue:G.text,fontWeight:isTd||isCur?700:400,fontSize:13,opacity:isCur?0.5:1}}>
                  {day}
                </div>
              );
            })}
          </div>
          <div style={{marginTop:14,display:"flex",justifyContent:"center"}}>
            <button onClick={()=>setMovePicker(null)} style={{padding:"8px 24px",borderRadius:12,background:"#F0F4F8",border:"none",cursor:"pointer",color:G.textMid,fontSize:13,fontWeight:700}}>ì·¨ì†Œ</button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div onClick={onClose} onMouseMove={onGlobalMove} onMouseUp={onGlobalUp} onTouchMove={onGlobalMove} onTouchEnd={onGlobalUp}
      style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(6px)",zIndex:150,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      {movePicker && <MiniCalPicker/>}
      <div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:480,background:"#fff",borderRadius:"24px 24px 0 0",boxShadow:"0 -8px 40px rgba(0,0,0,0.15)",overflow:"hidden",maxHeight:"88vh",display:"flex",flexDirection:"column",touchAction:"none"}}>
        <div style={{flexShrink:0,padding:"12px 0 0",display:"flex",justifyContent:"center"}}>
          <div style={{width:36,height:4,borderRadius:2,background:G.border}}/>
        </div>
        <div style={{flexShrink:0,padding:"10px 20px 14px",borderBottom:`1px solid ${G.borderLight}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontSize:11,color:G.textLight,fontWeight:700}}>{selectedDate.getFullYear()}.{String(selectedDate.getMonth()+1).padStart(2,"0")}</div>
            <div style={{fontSize:20,fontWeight:900,color:G.text,display:"flex",alignItems:"center",gap:8}}>
              {selectedDate.getDate()}ì¼ {DAYS_KO[selectedDate.getDay()]}ìš”ì¼
              {ds(selectedDate)===TODAY_STR && (<span style={{fontSize:10,background:G.green,color:"#fff",borderRadius:6,padding:"2px 8px",fontWeight:700}}>ì˜¤ëŠ˜</span>)}
            </div>
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <Btn variant="ghost" small onClick={()=>openAdd(9)}>+ ì¶”ê°€</Btn>
            <button onClick={onClose} style={{width:30,height:30,borderRadius:15,background:"#F0F4F8",border:"none",cursor:"pointer",fontSize:18,color:G.textLight,display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
          </div>
        </div>
        {dayBlocks.length > 0 && (
          <div style={{flexShrink:0,padding:"7px 20px 0",display:"flex",alignItems:"center",gap:10}}>
            <span style={{fontSize:10,color:G.textLight}}>â†•ï¸ ë“œë˜ê·¸ â†’ ì‹œê°„ ì´ë™</span>
            <span style={{fontSize:10,color:G.textLight}}>ğŸ“… ë²„íŠ¼ â†’ ë‚ ì§œ ì´ë™</span>
          </div>
        )}
        <div style={{flex:1,overflowY:"auto"}}>
          <div style={{padding:"6px 20px 4px"}}>
            {dayBlocks.length === 0 && (tasks[selStr]||[]).length === 0 ? (
              <div style={{textAlign:"center",padding:"28px 0",color:"#CBD5E0"}}><div style={{fontSize:32,marginBottom:8}}>ğŸŒ¿</div><div style={{fontSize:13}}>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            ) : (
              <>
                {[...dayBlocks].sort((a,b)=>a.start-b.start).map(b => {
                  const isDragging = isDraggingId === b.id;
                  return (
                    <div key={b.id} style={{display:"flex",alignItems:"stretch",gap:0,marginBottom:8,borderRadius:16,overflow:"hidden",
                      border:`1.5px solid ${isDragging?b.color:G.border}`,
                      boxShadow:isDragging?`0 8px 28px ${b.color}44`:"0 1px 4px rgba(0,0,0,0.04)",
                      transform:isDragging?"scale(1.02)":"scale(1)",transition:isDragging?"none":"all 0.15s",
                      background:isDragging?`${b.color}08`:"#fff",userSelect:"none",touchAction:"none"}}>
                      <div onMouseDown={e=>onCardMouseDown(e,b)} onTouchStart={e=>onCardTouchStart(e,b)}
                        style={{width:8,background:b.color,cursor:"ns-resize",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2,padding:"0 1px"}}>
                        {[0,1,2].map(i=>(<div key={i} style={{width:4,height:1,background:"rgba(255,255,255,0.6)",borderRadius:1}}/>))}
                      </div>
                      <div onClick={()=>{if(!cardDrag) openEdit(b);}} style={{flex:1,padding:"10px 12px",cursor:"pointer"}}>
                        <div style={{fontSize:14,fontWeight:700,color:G.text,marginBottom:3}}>{b.title}</div>
                        <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                          <span style={{fontSize:11,fontWeight:700,color:isDragging?b.color:G.textLight}}>{String(b.start).padStart(2,"0")}:00 â€“ {String(b.end).padStart(2,"0")}:00</span>
                          <span style={{fontSize:10,color:G.textLight}}>{b.end-b.start}ì‹œê°„</span>
                          {b.catId && <CatBadge catId={b.catId} cats={cats} small/>}
                        </div>
                      </div>
                      <button onClick={e=>openDatePicker(e,b.id)} style={{width:44,background:"transparent",border:"none",borderLeft:`1px solid ${G.borderLight}`,cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,padding:"0 6px",flexShrink:0,color:G.textLight}}
                        onMouseEnter={e=>e.currentTarget.style.background=G.greenSoft} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                        <span style={{fontSize:16}}>ğŸ“…</span>
                        <span style={{fontSize:8,fontWeight:700,color:G.green}}>ì´ë™</span>
                      </button>
                    </div>
                  );
                })}
                {(tasks[selStr]||[]).length > 0 && (
                  <>
                    <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,padding:"10px 0 6px"}}>í•  ì¼</div>
                    {(tasks[selStr]||[]).map(t=>(
                      <div key={t.id} style={{display:"flex",alignItems:"center",gap:12,padding:"8px 0",borderBottom:`1px solid ${G.borderLight}`}}>
                        <div style={{width:18,height:18,borderRadius:9,flexShrink:0,border:t.done?"none":`2px solid ${t.priority==="high"?G.red:t.priority==="medium"?G.yellow:G.blue}`,background:t.done?G.green:"#fff",display:"flex",alignItems:"center",justifyContent:"center"}}>
                          {t.done && <span style={{color:"#fff",fontSize:9,fontWeight:900}}>âœ“</span>}
                        </div>
                        <div style={{flex:1}}>
                          <span style={{fontSize:13,color:t.done?G.textLight:G.text,textDecoration:t.done?"line-through":"none",fontWeight:500}}>{t.title}</span>
                          {t.time && <span style={{fontSize:10,color:G.textLight,marginLeft:6}}>ğŸ• {t.time}</span>}
                        </div>
                      </div>
                    ))}
                  </>
                )}
                {readingLog[selStr]?.bookTitle && (
                  <div style={{display:"flex",alignItems:"center",gap:12,padding:"10px 0",marginTop:4}}>
                    <div style={{width:4,alignSelf:"stretch",borderRadius:2,background:G.green,minHeight:36,flexShrink:0}}/>
                    <div style={{flex:1}}>
                      <div style={{fontSize:14,fontWeight:700,color:G.greenDark}}>ğŸ“– {readingLog[selStr].bookTitle}</div>
                      <div style={{fontSize:10,color:G.green,marginTop:2}}>{readingLog[selStr].pageRange||""} Â· {readingLog[selStr].pages}p</div>
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
          <div onClick={()=>setShowTimeline(v=>!v)} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"13px 20px",background:showTimeline?G.greenSoft:"#F7FAFC",cursor:"pointer",borderTop:`1.5px solid ${showTimeline?G.greenMid:G.border}`,margin:"4px 0 0"}}>
            <div style={{display:"flex",alignItems:"center",gap:8}}>
              <span style={{fontSize:15}}>â±ï¸</span>
              <span style={{fontSize:13,fontWeight:700,color:showTimeline?G.greenDark:G.textMid}}>íƒ€ì„ë¼ì¸ ë³´ê¸°</span>
              {dayBlocks.length>0 && (<span style={{fontSize:10,background:showTimeline?G.green:G.border,color:showTimeline?"#fff":G.textLight,borderRadius:10,padding:"1px 7px",fontWeight:700}}>{dayBlocks.length}ê°œ</span>)}
            </div>
            <span style={{fontSize:18,color:showTimeline?G.green:G.textLight,transition:"transform 0.25s",display:"inline-block",transform:showTimeline?"rotate(90deg)":"rotate(0deg)"}}>â€º</span>
          </div>
          {showTimeline && (
            <div ref={gridRef} onMouseMove={onMove} onMouseUp={()=>setDragInfo(null)} onMouseLeave={()=>setDragInfo(null)}
              style={{position:"relative",height:24*52,background:"#FAFAFA",borderTop:`1px solid ${G.border}`,userSelect:"none",overflow:"hidden"}}>
              {HOURS.map(h=>(
                <div key={h} onClick={()=>openAdd(h)} style={{position:"absolute",left:0,right:0,top:h*52,height:52,borderTop:`1px solid ${h===0?"transparent":G.borderLight}`,cursor:"pointer"}}>
                  <span style={{position:"absolute",left:6,top:4,fontSize:9,color:"#CBD5E0",fontWeight:600}}>{String(h).padStart(2,"0")}:00</span>
                </div>
              ))}
              {dayBlocks.map(b=>{
                const top=b.start*52, bh=(b.end-b.start)*52;
                return (
                  <div key={b.id} onClick={e=>{e.stopPropagation();openEdit(b);}} onMouseDown={e=>startDrag(e,b.id,"move")}
                    style={{position:"absolute",left:42,right:6,top:top+2,height:bh-4,background:`${b.color}18`,border:`1.5px solid ${b.color}55`,borderLeft:`3px solid ${b.color}`,borderRadius:10,cursor:"grab",overflow:"hidden",padding:"4px 8px",boxSizing:"border-box"}}>
                    <div style={{fontSize:11,fontWeight:700,color:b.color,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{b.title}</div>
                    <div style={{fontSize:9,color:G.textLight,marginTop:1}}>{String(b.start).padStart(2,"0")}:00â€“{String(b.end).padStart(2,"0")}:00</div>
                    {b.catId && bh>60 && <CatBadge catId={b.catId} cats={cats} small/>}
                    <div onMouseDown={e=>{e.stopPropagation();startDrag(e,b.id,"resize");}} style={{position:"absolute",bottom:0,left:0,right:0,height:8,cursor:"s-resize"}}/>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function MonthlyView({ isMac, currentDate, setCurrentDate, selectedDate, setSelectedDate, timeblocks, setTimeblocks, readingLog, cats, tasks, budget, weeklyGoals, workoutLog, setTab }){
  const y = currentDate.getFullYear(), m = currentDate.getMonth();
  const selStr = ds(selectedDate);
  const [showModal, setShowModal] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({title:"",start:9,end:10,color:G.green,catId:null});
  const [dragInfo, setDragInfo] = useState(null);
  const [showTimeline, setShowTimeline] = useState(false);
  const [showDayPopup, setShowDayPopup] = useState(false);
  const gridRef = useRef(null);
  const dayBlocks = timeblocks[selStr]||[];

  const [lp, setLp] = useState(null);
  const lpTimer = useRef(null);
  const LONG_PRESS_MS = 500;

  function lpStart(e, blockId, srcDate) {
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    lpTimer.current = setTimeout(() => {
      setLp(prev => prev ? { ...prev, dragging: true } : null);
    }, LONG_PRESS_MS);
    setLp({ blockId, srcDate, startX: clientX, startY: clientY, dragging: false, ghostX: clientX, ghostY: clientY });
  }
  function lpMove(e) {
    if (!lp) return;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const moved = Math.abs(clientX - lp.startX) + Math.abs(clientY - lp.startY) > 5;
    if (moved && !lp.dragging) { clearTimeout(lpTimer.current); }
    if (lp.dragging) {
      e.preventDefault();
      setLp(prev => ({ ...prev, ghostX: clientX, ghostY: clientY }));
    }
  }
  function lpEnd(e) {
    clearTimeout(lpTimer.current);
    if (!lp || !lp.dragging) { setLp(null); return; }
    const el = document.elementFromPoint(lp.ghostX, lp.ghostY);
    const cell = el?.closest("[data-datestr]");
    const targetDate = cell?.getAttribute("data-datestr");
    if (targetDate && targetDate !== lp.srcDate) {
      setTimeblocks(prev => {
        const src = [...(prev[lp.srcDate]||[])];
        const idx = src.findIndex(b => b.id === lp.blockId);
        if (idx < 0) return prev;
        const block = src[idx];
        const newSrc = src.filter((_,i)=>i!==idx);
        const newDst = [...(prev[targetDate]||[]), {...block}];
        return {...prev, [lp.srcDate]: newSrc, [targetDate]: newDst};
      });
    }
    setLp(null);
  }

  const monthDays = getDays(y,m);
  let totalPages=0, bookSet=new Set();
  for(let i=1;i<=monthDays;i++){
    const k=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const r=readingLog[k];
    if(r){ totalPages+=r.pages||0; if(r.bookTitle) bookSet.add(r.bookTitle); }
  }

  function openAdd(h){ setEditId(null); setForm({title:"",start:h,end:h+1,color:G.green,catId:null}); setShowModal(true); }
  function openEdit(b){ setEditId(b.id); setForm({title:b.title,start:b.start,end:b.end,color:b.color,catId:b.catId}); setShowModal(true); }
  function save(){
    if(!form.title.trim()) return;
    setTimeblocks(p=>{
      const bl=[...(p[selStr]||[])];
      if(editId){ const i=bl.findIndex(b=>b.id===editId); if(i>=0) bl[i]={...bl[i],...form}; }
      else bl.push({id:Date.now(),...form});
      return {...p,[selStr]:bl};
    });
    setShowModal(false);
  }
  function del(){ setTimeblocks(p=>({...p,[selStr]:(p[selStr]||[]).filter(b=>b.id!==editId)})); setShowModal(false); }
  function startDrag(e,id,type){ e.stopPropagation(); setDragInfo({id,type}); }
  function onMove(e){
    if(!dragInfo||!gridRef.current) return;
    const rect=gridRef.current.getBoundingClientRect();
    const hour=Math.max(0,Math.min(23,Math.floor((e.clientY-rect.top)/52)));
    setTimeblocks(p=>{
      const bl=[...(p[selStr]||[])];
      const i=bl.findIndex(b=>b.id===dragInfo.id); if(i<0) return p;
      const b={...bl[i]};
      if(dragInfo.type==="move"){ const dur=b.end-b.start; b.start=Math.max(0,Math.min(23-dur,hour)); b.end=b.start+dur; }
      else { b.end=Math.max(b.start+1,Math.min(24,hour+1)); }
      bl[i]=b; return {...p,[selStr]:bl};
    });
  }

  const totalCells = getFirst(y,m)+getDays(y,m);
  const rows = Math.ceil(totalCells/7);

  // ê²°ì‚° ì»¬ëŸ¼ ë„ˆë¹„: ëª¨ë°”ì¼ 36px, ë§¥ 48px
  const summaryW = isMac ? 48 : 36;
  // ê·¸ë¦¬ë“œ í…œí”Œë¦¿: 7ì—´ ë™ì¼ + ê²°ì‚° ì—´
  const gridCols = `repeat(7,1fr) ${summaryW}px`;

  return (
    <div onMouseMove={lpMove} onMouseUp={lpEnd} onTouchMove={lpMove} onTouchEnd={lpEnd}
      style={{display:"flex",flexDirection:"column",flex:1,minHeight:0}}>

      {lp?.dragging && (() => {
        const block = Object.values(timeblocks).flat().find(b=>b.id===lp.blockId);
        return block ? (
          <div style={{position:"fixed",left:lp.ghostX-60,top:lp.ghostY-18,zIndex:999,pointerEvents:"none",
            background:block.color,color:"#fff",borderRadius:12,padding:"6px 14px",fontSize:11,fontWeight:700,
            boxShadow:`0 8px 24px ${block.color}66`,opacity:0.92,whiteSpace:"nowrap"}}>
            ğŸ“¦ {block.title}
          </div>
        ) : null;
      })()}

      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10,flexShrink:0}}>
        <button style={{...navBtnStyle}} onClick={()=>setCurrentDate(new Date(y,m-1,1))}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.text,fontWeight:800,fontSize:17}}>{y}ë…„ {MONTHS_KO[m]}</div>
          {(totalPages>0||bookSet.size>0) && (<div style={{fontSize:11,color:G.green,fontWeight:600,marginTop:2}}>ğŸ“– {totalPages}p Â· {bookSet.size}ê¶Œ</div>)}
        </div>
        <button style={{...navBtnStyle}} onClick={()=>setCurrentDate(new Date(y,m+1,1))}>â€º</button>
      </div>

      <div style={{display:"grid",gridTemplateColumns:gridCols,marginBottom:3,flexShrink:0}}>
        {DAYS_KO.map((d,i)=>(<div key={d} style={{textAlign:"center",fontSize:11,fontWeight:700,color:i===0?G.red:i===6?G.blue:G.textLight,paddingBottom:4}}>{d}</div>))}
        <div style={{textAlign:"center",fontSize:9,fontWeight:700,color:G.green,paddingBottom:4}}>ê²°ì‚°</div>
      </div>

      {/* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ â€” flex:1ë¡œ ë‚¨ì€ ê³µê°„ ê½‰ ì±„ì›€ */}
      <div style={{flex:1,display:"flex",flexDirection:"column",gap:2}}>
      {Array.from({length:rows},(_,rowIdx)=>{
        const firstOffset = getFirst(y,m);
        const rowDays = Array.from({length:7},(_,col)=>{
          const dayNum = rowIdx*7 + col - firstOffset + 1;
          if(dayNum<1||dayNum>getDays(y,m)) return null;
          return dayNum;
        });
        const firstValidDay = rowDays.find(d=>d!==null);
        const rowWeekDates = rowDays.map(d=>d?`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`:null).filter(Boolean);
        const wkPages = rowWeekDates.reduce((a,k)=>a+(readingLog[k]?.pages||0),0);
        const wkBooks = new Set(rowWeekDates.map(k=>readingLog[k]?.bookTitle).filter(Boolean));
        const wkExpense = rowWeekDates.reduce((a,k)=>{
          return a + (budget[k]||[]).filter(e=>e.type==="expense").reduce((s,e)=>s+e.amount,0);
        },0);
        const wkWorkouts = rowWeekDates.reduce((a,k)=>a+(workoutLog[k]||[]).length,0);
        const wkGoalPct = (() => {
          if(!firstValidDay) return null;
          const wkRef = new Date(y,m,firstValidDay);
          const wkKey = getWeekKey(wkRef);
          const goals = weeklyGoals[wkKey]||[];
          if(!goals.length) return null;
          let total=0,done=0;
          goals.forEach(g=>{
            total+=g.chunks.length;
            done+=rowWeekDates.reduce((a,k)=>a+(tasks[k]||[]).filter(t=>t.catId===g.catId&&t.done&&t.auto&&t.weeklyGoalId===g.id).length,0);
          });
          return total>0?Math.round(done/total*100):null;
        })();

        return (
          <div key={rowIdx} style={{display:"grid",gridTemplateColumns:gridCols,gap:2,flex:1}}>
            {rowDays.map((day,col)=>{
              if(!day) return <div key={`e${rowIdx}_${col}`} style={{background:"#FAFAFA",borderRadius:4}}/>;
              const dStr=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
              const dBlocks=timeblocks[dStr]||[];
              const reading=readingLog[dStr];
              const isToday=dStr===TODAY_STR; const isSel=dStr===selStr;
              const dow=new Date(y,m,day).getDay();
              return (
                <div key={day} data-datestr={dStr}
                  onClick={()=>{ if(lp?.dragging) return; setSelectedDate(new Date(y,m,day)); setShowDayPopup(true); setShowTimeline(false); }}
                  style={{background:isSel?G.greenSoft:"#fff",padding:"4px 3px",cursor:"pointer",
                    borderBottom:isToday?`2.5px solid ${G.green}`:"none",transition:"background 0.15s",borderRadius:4,
                    outline:"none",userSelect:"none",overflow:"hidden"}}>
                  <div style={{width:24,height:24,borderRadius:12,background:isToday?G.green:"transparent",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:isToday?800:400,color:isToday?"#fff":dow===0?G.red:dow===6?G.blue:G.text,marginBottom:2}}>{day}</div>
                  {dBlocks.slice(0,isMac?4:3).map(b=>(
                    <div key={b.id}
                      onMouseDown={e=>{ e.stopPropagation(); lpStart(e,b.id,dStr); }}
                      onTouchStart={e=>{ e.stopPropagation(); lpStart(e,b.id,dStr); }}
                      style={{fontSize:9,fontWeight:600,background:lp?.blockId===b.id&&lp?.dragging?"transparent":b.color,borderRadius:4,padding:"1.5px 4px",marginBottom:1.5,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",lineHeight:1.4,cursor:"grab",
                        opacity:lp?.blockId===b.id&&lp?.dragging?0.3:1,
                        border:lp?.blockId===b.id&&lp?.dragging?`1.5px dashed ${b.color}`:"none",
                        color:lp?.blockId===b.id&&lp?.dragging?b.color:"#fff",
                        transition:"opacity 0.15s"}}>
                      {b.title}
                    </div>
                  ))}
                  {dBlocks.length>(isMac?4:3) && <div style={{fontSize:8,color:G.textLight,fontWeight:600}}>+{dBlocks.length-(isMac?4:3)}ê°œ</div>}
                  {reading && reading.bookTitle && (
                    <div style={{marginTop:2,background:G.greenSoft,borderRadius:4,padding:"2px 3px",border:`1px solid ${G.greenMid}`}}>
                      <div style={{fontSize:8,color:G.greenDark,fontWeight:700,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>ğŸ“– {reading.bookTitle}</div>
                      <div style={{fontSize:8,color:G.green,fontWeight:600}}>{reading.pages}p</div>
                    </div>
                  )}
                </div>
              );
            })}
            <div
              onDoubleClick={()=>{
                if(!firstValidDay) return;
                // í•´ë‹¹ ì£¼ì˜ ë‚ ì§œë¡œ selectedDate ì´ë™ í›„ ì£¼ê°„ íƒ­ìœ¼ë¡œ ì „í™˜
                setSelectedDate(new Date(y, m, firstValidDay));
                setTab("weekly");
              }}
              title="ë”ë¸”í´ë¦­ â†’ í•´ë‹¹ ì£¼ ì£¼ê°„ ê³„íš"
              style={{background:`linear-gradient(180deg,${G.greenSoft},#F0F7FF)`,borderRadius:6,padding:"4px 3px",display:"flex",flexDirection:"column",gap:2,justifyContent:"center",border:`1px solid ${G.greenMid}44`,overflow:"hidden",cursor:"pointer",transition:"filter 0.15s"}}
              onMouseEnter={e=>e.currentTarget.style.filter="brightness(0.95)"}
              onMouseLeave={e=>e.currentTarget.style.filter="brightness(1)"}
            >
              {wkPages>0&&<div style={{fontSize:8,color:G.green,fontWeight:700,lineHeight:1.3}}>ğŸ“–{wkPages}p</div>}
              {wkBooks.size>0&&[...wkBooks].map(b=><div key={b} style={{fontSize:7,color:G.greenDark,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:1.2}}>{b}</div>)}
              {wkWorkouts>0&&<div style={{fontSize:8,color:"#7C3AED",fontWeight:700,lineHeight:1.3}}>ğŸ‹ï¸{wkWorkouts}íšŒ</div>}
              {wkExpense>0&&<div style={{fontSize:8,color:G.red,fontWeight:700,lineHeight:1.3}}>ğŸ’¸{wkExpense>=10000?Math.round(wkExpense/10000)+"ë§Œ":wkExpense+"ì›"}</div>}
              {wkGoalPct!==null&&<div style={{fontSize:8,fontWeight:700,lineHeight:1.3,color:wkGoalPct>=80?G.green:wkGoalPct>=50?G.yellow:G.red}}>ğŸ¯{wkGoalPct}%</div>}
              {wkPages===0&&wkWorkouts===0&&wkExpense===0&&wkGoalPct===null&&<div style={{fontSize:8,color:"#CBD5E0",textAlign:"center",lineHeight:1.3}}>â€“</div>}
              {/* ë”ë¸”íƒ­ íŒíŠ¸ ì•„ì´ì½˜ */}
              <div style={{fontSize:7,color:`${G.green}88`,textAlign:"center",marginTop:"auto",lineHeight:1.5}}>â†—</div>
            </div>
          </div>
        );
      })}
      </div>{/* end flex rows */}

      {showDayPopup && (
        <DayPopup selectedDate={selectedDate} dayBlocks={dayBlocks} tasks={tasks} selStr={selStr}
          readingLog={readingLog} cats={cats} showTimeline={showTimeline} setShowTimeline={setShowTimeline}
          onClose={()=>{ setShowDayPopup(false); setShowTimeline(false); }}
          openEdit={openEdit} openAdd={openAdd} setTimeblocks={setTimeblocks}
          gridRef={gridRef} onMove={onMove} setDragInfo={setDragInfo} startDrag={startDrag}/>
      )}

      <Modal show={showModal} onClose={()=>setShowModal(false)} title={editId?"ë¸”ë¡ ìˆ˜ì •":"ìƒˆ íƒ€ì„ë¸”ë¡"}>
        <input value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))} placeholder="ë¸”ë¡ ì´ë¦„..." style={inp()} autoFocus/>
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          <div style={{flex:1}}>
            <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:4}}>ì‹œì‘</div>
            <select value={form.start} onChange={e=>setForm(f=>({...f,start:+e.target.value}))} style={selStyle}>
              {HOURS.map(h=><option key={h} value={h}>{String(h).padStart(2,"0")}:00</option>)}
            </select>
          </div>
          <div style={{flex:1}}>
            <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:4}}>ì¢…ë£Œ</div>
            <select value={form.end} onChange={e=>setForm(f=>({...f,end:+e.target.value}))} style={selStyle}>
              {HOURS.filter(h=>h>form.start).map(h=><option key={h} value={h}>{String(h).padStart(2,"0")}:00</option>)}
              <option value={24}>24:00</option>
            </select>
          </div>
        </div>
        <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:8}}>ëª©í‘œ ì—°ê²°</div>
        <div style={{display:"flex",gap:6,marginBottom:16,flexWrap:"wrap"}}>
          <button onClick={()=>setForm(f=>({...f,catId:null,color:"#A0AEC0"}))} style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${!form.catId?G.green:G.border}`,background:!form.catId?G.greenSoft:"#fff",color:!form.catId?G.green:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>ì—†ìŒ</button>
          {cats.map(c=>(<button key={c.id} onClick={()=>setForm(f=>({...f,catId:c.id,color:c.color}))} style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${form.catId===c.id?c.color:G.border}`,background:form.catId===c.id?`${c.color}18`:"#fff",color:form.catId===c.id?c.color:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>{c.icon} {c.label}</button>))}
        </div>
        <div style={{display:"flex",gap:8}}>
          {editId && <Btn variant="danger" style={{flex:1}} onClick={del}>ì‚­ì œ</Btn>}
          <Btn variant="primary" style={{flex:2}} onClick={save}>ì €ì¥</Btn>
        </div>
      </Modal>
    </div>
  );
}

function WeeklyView({ selectedDate, setSelectedDate, tasks, setTasks, weeklyGoals, setWeeklyGoals, readingLog, cats }){
  const wk = getWeekKey(selectedDate);
  const wd = getWeekDates(selectedDate);
  const goals = weeklyGoals[wk]||[];
  const [subTab, setSubTab] = useState("plan");
  const [showAdd, setShowAdd] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({catId:"",title:"",activeDays:[1,2,3,4,5],chunks:[]});

  function prev(){ const d=new Date(selectedDate);d.setDate(d.getDate()-7);setSelectedDate(d); }
  function next(){ const d=new Date(selectedDate);d.setDate(d.getDate()+7);setSelectedDate(d); }
  function toggleDay(day){ setForm(f=>{ const days=f.activeDays.includes(day)?f.activeDays.filter(d=>d!==day):[...f.activeDays,day].sort(); const chunks=days.map(d=>({day:d,desc:(f.chunks.find(c=>c.day===d)||{}).desc||""})); return {...f,activeDays:days,chunks}; }); }
  function updateChunk(day,desc){ setForm(f=>({...f,chunks:f.chunks.map(c=>c.day===day?{...c,desc}:c)})); }
  function openNew(){ const defaultCat=cats[0]?.id||""; setEditId(null); setForm({catId:defaultCat,title:"",activeDays:[0,1,2,3,4,5,6],chunks:[0,1,2,3,4,5,6].map(d=>({day:d,desc:""}))}); setShowAdd(true); }
  function openEdit(g){ setEditId(g.id); setForm({catId:g.catId,title:g.title,activeDays:[...g.activeDays],chunks:g.chunks.map(c=>({...c}))}); setShowAdd(true); }
  function syncToDaily(gId,gForm){
    setTasks(prev=>{
      const next={...prev};
      wd.forEach(d=>{ const k=ds(d); if(next[k]) next[k]=next[k].filter(t=>!(t.auto&&t.weeklyGoalId===gId)); });
      gForm.chunks.forEach(chunk=>{
        const d=wd[chunk.day]; if(!d||!chunk.desc) return;
        const k=ds(d); const c=cats.find(x=>x.id===gForm.catId);
        next[k]=[...(next[k]||[]),{id:Date.now()+chunk.day+Math.random(),title:`${c?.label||""}: ${chunk.desc}`,done:false,priority:"high",catId:gForm.catId,auto:true,weeklyGoalId:gId,time:""}];
      });
      return next;
    });
  }
  function save(){
    if(!form.title.trim()) return;
    const id=editId||Date.now();
    setWeeklyGoals(prev=>{ const list=[...(prev[wk]||[])]; if(editId){ const i=list.findIndex(g=>g.id===editId); if(i>=0) list[i]={...list[i],...form}; } else list.push({id,...form,retro:""}); return {...prev,[wk]:list}; });
    syncToDaily(id,form);
    setShowAdd(false);
  }
  function updateRetro(gId,text){ setWeeklyGoals(prev=>({...prev,[wk]:(prev[wk]||[]).map(g=>g.id===gId?{...g,retro:text}:g)})); }

  let weekPages=0, weekBooks=new Set();
  wd.forEach(d=>{ const r=readingLog[ds(d)]; if(r){ weekPages+=r.pages||0; if(r.bookTitle) weekBooks.add(r.bookTitle); }});
  const wLabel = `${wd[0].getMonth()+1}.${String(wd[0].getDate()).padStart(2,"0")} â€“ ${wd[6].getMonth()+1}.${String(wd[6].getDate()).padStart(2,"0")}`;
  const wMonth = wd[3];
  const weekOfMonth = getWeekOfMonth(wMonth);
  const weekLabel = `${wMonth.getMonth()+1}ì›” ${weekOrdinalKo(weekOfMonth)}ì£¼`;

  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
        <button style={navBtnStyle} onClick={prev}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.text,fontSize:18,fontWeight:900,letterSpacing:-0.3}}>{weekLabel}</div>
          <div style={{color:G.textMid,fontSize:12,fontWeight:600,marginTop:1}}>{wLabel}</div>
          {weekPages>0 && <div style={{fontSize:11,color:G.green,fontWeight:600,marginTop:1}}>ğŸ“– ì£¼ê°„ {weekPages}p Â· {weekBooks.size}ê¶Œ</div>}
        </div>
        <button style={navBtnStyle} onClick={next}>â€º</button>
      </div>
      <div style={{display:"flex",gap:6,margin:"16px 0 20px"}}>
        {[{k:"plan",l:"ğŸ“‹ ì£¼ê°„ ê³„íš"},{k:"retro",l:"ğŸ” ì£¼ê°„ íšŒê³ "},{k:"reading",l:"ğŸ“– ë…ì„œ"}].map(t=>(
          <button key={t.k} onClick={()=>setSubTab(t.k)} style={{flex:1,padding:"9px 0",borderRadius:14,border:"none",cursor:"pointer",fontSize:11,fontWeight:700,background:subTab===t.k?G.green:"#F0F4F8",color:subTab===t.k?"#fff":G.textMid,boxShadow:subTab===t.k?`0 3px 10px ${G.green}44`:"none",transition:"all 0.2s"}}>{t.l}</button>
        ))}
      </div>
      {subTab==="plan" && (
        <div>
          {goals.map(goal=>{
            const c=cats.find(x=>x.id===goal.catId);
            return (
              <div key={goal.id} style={{marginBottom:12,background:"#fff",borderRadius:18,overflow:"hidden",border:`1.5px solid ${c?.color||G.green}33`,boxShadow:"0 2px 8px rgba(0,0,0,0.05)"}}>
                <div style={{padding:"12px 14px 10px",borderBottom:`1px solid ${G.borderLight}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div><CatBadge catId={goal.catId} cats={cats}/><div style={{color:G.text,fontSize:14,fontWeight:700,marginTop:5}}>{goal.title}</div></div>
                  <div style={{display:"flex",gap:6}}>
                    <button onClick={()=>syncToDaily(goal.id,goal)} style={{padding:"6px 10px",borderRadius:20,border:`1.5px solid ${G.green}55`,background:G.greenSoft,color:G.green,fontSize:10,fontWeight:700,cursor:"pointer"}}>ì¼ê°„â†—</button>
                    <button onClick={()=>openEdit(goal)} style={navBtnStyle}>âœï¸</button>
                  </div>
                </div>
                <div style={{padding:"8px 14px 12px"}}>
                  {[0,1,2,3,4,5,6].map(dayNum=>{ 
                    const chunk=goal.chunks.find(c=>c.day===dayNum)||{day:dayNum,desc:""};
                    const d=wd[dayNum]; const isTd=d&&ds(d)===TODAY_STR;
                    const active=goal.activeDays?.includes(dayNum);
                    return (
                    <div key={dayNum} style={{display:"flex",alignItems:"center",gap:10,padding:"6px 0",borderBottom:`1px solid ${G.borderLight}`,opacity:active?1:0.4}}>
                      <div style={{minWidth:30,textAlign:"center"}}>
                        <div style={{fontSize:9,color:dayNum===0?G.red:dayNum===6?G.blue:G.textLight,fontWeight:700}}>{DAYS_KO[dayNum]}</div>
                        <div style={{fontSize:14,fontWeight:800,color:isTd?G.green:G.text}}>{d?.getDate()}</div>
                      </div>
                      <div style={{flex:1,padding:"6px 10px",background:isTd?G.greenSoft:active?"#F7FAFC":"transparent",borderRadius:10,color:G.textMid,fontSize:12,fontWeight:500,borderLeft:isTd?`3px solid ${G.green}`:"3px solid transparent"}}>
                        {chunk.desc||<span style={{color:"#CBD5E0"}}>{active?"ë‚´ìš© ì—†ìŒ":"â€“"}</span>}
                      </div>
                    </div>
                  );})}
                </div>
              </div>
            );
          })}
          <button onClick={openNew} style={{width:"100%",padding:"14px 0",borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ ì£¼ê°„ ëª©í‘œ ì¶”ê°€</button>
        </div>
      )}
      {subTab==="retro" && (
        <div>
          <div style={{color:G.textLight,fontSize:11,letterSpacing:1,marginBottom:14,fontWeight:600}}>ì´ë²ˆ ì£¼ë¥¼ ëŒì•„ë³´ì„¸ìš”</div>
          {goals.map(goal=>{
            const c=cats.find(x=>x.id===goal.catId);
            const done=wd.reduce((a,d)=>a+(tasks[ds(d)]||[]).filter(t=>t.catId===goal.catId&&t.done&&t.auto).length,0);
            const pct=goal.chunks.length>0?Math.round(done/goal.chunks.length*100):0;
            return (
              <div key={goal.id} style={{marginBottom:14,background:"#fff",borderRadius:18,padding:16,border:`1.5px solid ${c?.color||G.green}33`,boxShadow:"0 2px 8px rgba(0,0,0,0.04)"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}><CatBadge catId={goal.catId} cats={cats}/><span style={{fontSize:24,fontWeight:900,color:c?.color||G.green}}>{pct}%</span></div>
                <div style={{height:6,background:"#EDF2F7",borderRadius:3,marginBottom:12,overflow:"hidden"}}>
                  <div style={{height:"100%",width:`${pct}%`,background:c?.color||G.green,borderRadius:3,transition:"width 0.5s ease"}}/>
                </div>
                <textarea value={goal.retro} onChange={e=>updateRetro(goal.id,e.target.value)} placeholder="ì´ë²ˆ ì£¼ íšŒê³ ..." style={{width:"100%",background:"#F7FAFC",border:`1.5px solid ${G.border}`,borderRadius:12,padding:"10px 12px",color:G.textMid,fontSize:12,resize:"none",height:68,outline:"none",fontFamily:"inherit",boxSizing:"border-box"}}/>
              </div>
            );
          })}
          {goals.length===0 && <div style={{textAlign:"center",color:"#CBD5E0",fontSize:13,paddingTop:30}}>ë¨¼ì € ì£¼ê°„ ê³„íšì„ ì¶”ê°€í•˜ì„¸ìš”</div>}
        </div>
      )}
      {subTab==="reading" && (
        <div>
          <div style={{background:G.greenSoft,borderRadius:16,padding:16,border:`1.5px solid ${G.greenMid}`,marginBottom:16}}>
            <div style={{fontSize:11,fontWeight:800,color:G.greenDark,letterSpacing:1,marginBottom:10}}>ğŸ“š ì´ë²ˆ ì£¼ ë…ì„œ í˜„í™©</div>
            <div style={{display:"flex",gap:16,marginBottom:10}}>
              <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:G.green}}>{weekPages}</div><div style={{fontSize:10,color:G.textLight,fontWeight:600}}>ì´ í˜ì´ì§€</div></div>
              <div style={{width:1,background:G.greenMid}}/>
              <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:G.green}}>{weekBooks.size}</div><div style={{fontSize:10,color:G.textLight,fontWeight:600}}>ì½ì€ ì±…</div></div>
            </div>
            {[...weekBooks].map(book=>{ const bPages=wd.reduce((a,d)=>{ const r=readingLog[ds(d)]; return a+(r&&r.bookTitle===book?r.pages:0);},0); return (
              <div key={book} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderTop:`1px solid ${G.greenMid}`,fontSize:12}}>
                <span style={{color:G.text,fontWeight:600}}>ğŸ“– {book}</span><span style={{color:G.green,fontWeight:700}}>{bPages}p</span>
              </div>
            );})}
            {weekBooks.size===0 && <div style={{fontSize:12,color:G.textLight}}>ì´ë²ˆ ì£¼ ë…ì„œ ê¸°ë¡ì´ ì—†ì–´ìš”</div>}
          </div>
          {wd.map((d,i)=>{ const k=ds(d); const r=readingLog[k]; const isTd=k===TODAY_STR; return (
            <div key={i} style={{display:"flex",alignItems:"center",gap:12,padding:"8px 0",borderBottom:`1px solid ${G.borderLight}`}}>
              <div style={{minWidth:32,textAlign:"center"}}>
                <div style={{fontSize:9,color:i===0?G.red:i===6?G.blue:G.textLight,fontWeight:700}}>{DAYS_KO[i]}</div>
                <div style={{fontSize:16,fontWeight:800,color:isTd?G.green:G.text}}>{d.getDate()}</div>
              </div>
              {r ? (
                <div style={{flex:1}}><div style={{fontSize:12,color:G.text,fontWeight:600}}>ğŸ“– {r.bookTitle}</div><div style={{display:"flex",gap:6,marginTop:1}}>{r.pageRange&&<span style={{fontSize:10,color:G.textLight}}>{r.pageRange}</span>}<span style={{fontSize:10,color:G.green,fontWeight:700}}>{r.pages}p</span></div></div>
              ) : (<div style={{flex:1,fontSize:12,color:"#CBD5E0"}}>ê¸°ë¡ ì—†ìŒ</div>)}
            </div>
          );})}
        </div>
      )}
      <Modal show={showAdd} onClose={()=>setShowAdd(false)} title={`ì£¼ê°„ ëª©í‘œ ${editId?"ìˆ˜ì •":"ì¶”ê°€"}`}>
        <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:8,letterSpacing:1}}>ì¹´í…Œê³ ë¦¬</div>
        <div style={{display:"flex",gap:6,marginBottom:14,flexWrap:"wrap"}}>
          {cats.map(c=>(<button key={c.id} onClick={()=>setForm(f=>({...f,catId:c.id}))} style={{padding:"7px 12px",borderRadius:12,border:`1.5px solid ${form.catId===c.id?c.color:G.border}`,background:form.catId===c.id?`${c.color}18`:"#fff",color:form.catId===c.id?c.color:G.textLight,fontSize:12,cursor:"pointer",fontWeight:700}}>{c.icon} {c.label}</button>))}
        </div>
        <input value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))} placeholder="ëª©í‘œ ì œëª©" style={inp()}/>
        <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:8,letterSpacing:1}}>ì‹¤í–‰ ìš”ì¼</div>
        <div style={{display:"flex",gap:4,marginBottom:16}}>
          {[1,2,3,4,5,6,0].map(day=>(<button key={day} onClick={()=>toggleDay(day)} style={{flex:1,padding:"8px 0",borderRadius:10,border:`1.5px solid ${form.activeDays.includes(day)?G.green:G.border}`,background:form.activeDays.includes(day)?G.greenSoft:"#fff",color:form.activeDays.includes(day)?G.greenDark:day===0?G.red:day===6?G.blue:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>{DAYS_KO[day]}</button>))}
        </div>
        {form.chunks.length>0 && (
          <div>
            <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:8,letterSpacing:1}}>ì¼ë³„ ì„¸ë¶€ ê³„íš</div>
            {form.chunks.map(chunk=>(<div key={chunk.day} style={{display:"flex",alignItems:"center",gap:10,marginBottom:8}}><div style={{minWidth:24,textAlign:"center",color:chunk.day===0?G.red:chunk.day===6?G.blue:G.textMid,fontSize:12,fontWeight:800}}>{DAYS_KO[chunk.day]}</div><input value={chunk.desc} onChange={e=>updateChunk(chunk.day,e.target.value)} placeholder={`${DAYS_KO[chunk.day]}ìš”ì¼ ë‚´ìš©...`} style={{...inp(),marginBottom:0,flex:1,padding:"10px 12px",fontSize:12}}/></div>))}
          </div>
        )}
        <Btn variant="primary" style={{width:"100%",marginTop:16}} onClick={save}>ì €ì¥ ë° ì¼ê°„ ë°˜ì˜</Btn>
      </Modal>
    </div>
  );
}

function DailyView({ selectedDate, setSelectedDate, tasks, setTasks, timeblocks, readingLog, setReadingLog, cats }){
  const selStr = ds(selectedDate);
  const dayTasks = tasks[selStr]||[];
  const dayBlocks = timeblocks[selStr]||[];
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({title:"",priority:"medium",catId:null,time:""});
  function toggle(id){ setTasks(p=>({...p,[selStr]:(p[selStr]||[]).map(t=>t.id===id?{...t,done:!t.done}:t)})); }
  function addTask(){ if(!form.title.trim()) return; setTasks(p=>({...p,[selStr]:[...(p[selStr]||[]),{id:Date.now(),...form,done:false,auto:false}]})); setForm({title:"",priority:"medium",catId:null,time:""}); setShowAdd(false); }
  function prev(){ const d=new Date(selectedDate);d.setDate(d.getDate()-1);setSelectedDate(d); }
  function next(){ const d=new Date(selectedDate);d.setDate(d.getDate()+1);setSelectedDate(d); }
  const pct=dayTasks.length>0?Math.round(dayTasks.filter(t=>t.done).length/dayTasks.length*100):0;
  const groups=[...cats.map(c=>({...c,items:dayTasks.filter(t=>t.catId===c.id)})),{id:null,label:"ê¸°íƒ€",color:"#A0AEC0",icon:"ğŸ“Œ",items:dayTasks.filter(t=>!t.catId)}].filter(g=>g.items.length>0);
  const PC={high:G.red,medium:G.yellow,low:G.blue};
  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
        <button style={navBtnStyle} onClick={prev}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.textLight,fontSize:10,letterSpacing:1.5,fontWeight:700}}>{selectedDate.getFullYear()}.{String(selectedDate.getMonth()+1).padStart(2,"0")}</div>
          <div style={{color:G.text,fontSize:20,fontWeight:800}}>{selectedDate.getDate()}ì¼ {DAYS_KO[selectedDate.getDay()]}ìš”ì¼</div>
        </div>
        <button style={navBtnStyle} onClick={next}>â€º</button>
      </div>
      {dayBlocks.length>0 && (
        <div style={{marginBottom:14}}>
          <div style={{color:G.textLight,fontSize:9,letterSpacing:1.5,textTransform:"uppercase",fontWeight:700,marginBottom:6}}>íƒ€ì„ë¸”ë¡</div>
          <div style={{display:"flex",height:28,borderRadius:10,overflow:"hidden",background:"#EDF2F7",gap:1}}>
            {[...dayBlocks].sort((a,b)=>a.start-b.start).map(b=>(<div key={b.id} style={{flex:b.end-b.start,background:b.color,display:"flex",alignItems:"center",justifyContent:"center",fontSize:8,color:"#fff",fontWeight:700,overflow:"hidden",whiteSpace:"nowrap",padding:"0 3px"}} title={b.title}>{b.title}</div>))}
          </div>
        </div>
      )}
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
        <div style={{color:G.textLight,fontSize:9,letterSpacing:1.5,textTransform:"uppercase",fontWeight:700}}>í•  ì¼</div>
        <span style={{fontSize:11,color:G.green,fontWeight:700}}>{dayTasks.filter(t=>t.done).length}/{dayTasks.length}</span>
      </div>
      <div style={{height:5,background:"#EDF2F7",borderRadius:3,marginBottom:16,overflow:"hidden"}}>
        <div style={{height:"100%",borderRadius:3,background:G.green,width:`${pct}%`,transition:"width 0.4s ease"}}/>
      </div>
      {groups.map(group=>(
        <div key={group.id||"misc"} style={{marginBottom:18}}>
          <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:8}}><span style={{fontSize:13}}>{group.icon}</span><span style={{fontSize:10,fontWeight:800,color:group.color,letterSpacing:1,textTransform:"uppercase"}}>{group.label}</span></div>
          {group.items.map(task=>(
            <div key={task.id} onClick={()=>toggle(task.id)} style={{display:"flex",alignItems:"flex-start",gap:12,padding:"11px 0",cursor:"pointer",borderBottom:`1px solid ${G.borderLight}`}}>
              <div style={{width:22,height:22,borderRadius:11,flexShrink:0,marginTop:1,border:task.done?"none":`2px solid ${PC[task.priority]||G.blue}`,background:task.done?G.green:"#fff",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:task.done?`0 2px 8px ${G.green}55`:"none"}}>
                {task.done && <span style={{color:"#fff",fontSize:11,fontWeight:900}}>âœ“</span>}
              </div>
              <div style={{flex:1}}>
                <div style={{color:task.done?"#CBD5E0":G.text,fontSize:13,fontWeight:500,textDecoration:task.done?"line-through":"none"}}>{task.title}</div>
                <div style={{display:"flex",gap:5,marginTop:3,flexWrap:"wrap"}}>
                  {task.time && <span style={{fontSize:10,color:G.textLight}}>ğŸ• {task.time}</span>}
                  {task.auto && <span style={{fontSize:9,padding:"2px 6px",borderRadius:4,background:`${G.green}18`,color:G.green,fontWeight:700}}>ìë™ë¶„ë°°</span>}
                  <span style={{fontSize:9,padding:"2px 6px",borderRadius:4,fontWeight:700,background:task.priority==="high"?"#FFF5F5":task.priority==="medium"?"#FFFBEB":"#EBF4FF",color:PC[task.priority]||G.blue}}>{task.priority==="high"?"ë†’ìŒ":task.priority==="medium"?"ë³´í†µ":"ë‚®ìŒ"}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      ))}
      {dayTasks.length===0 && (<div style={{textAlign:"center",padding:"24px 0",color:"#CBD5E0"}}><div style={{fontSize:36,marginBottom:8}}>ğŸŒ¿</div><div style={{fontSize:13,fontWeight:600}}>ì˜¤ëŠ˜ì˜ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div></div>)}
      <button onClick={()=>setShowAdd(true)} style={{width:"100%",padding:"13px 0",marginTop:4,borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ í•  ì¼ ì¶”ê°€</button>
      <div style={{height:1,background:G.border,margin:"16px 0"}}/>
      <ReadingLogEntry dateStr={selStr} readingLog={readingLog} setReadingLog={setReadingLog}/>
      <Modal show={showAdd} onClose={()=>setShowAdd(false)} title="í•  ì¼ ì¶”ê°€">
        <input value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))} onKeyDown={e=>e.key==="Enter"&&addTask()} placeholder="í•  ì¼ ì…ë ¥..." style={inp()} autoFocus/>
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          {["high","medium","low"].map(p=>(<button key={p} onClick={()=>setForm(f=>({...f,priority:p}))} style={{flex:1,padding:"9px 0",borderRadius:12,border:`1.5px solid ${form.priority===p?PC[p]:G.border}`,background:form.priority===p?`${PC[p]}18`:"#fff",color:form.priority===p?PC[p]:G.textLight,fontSize:12,fontWeight:700,cursor:"pointer"}}>{p==="high"?"ğŸ”´ ë†’ìŒ":p==="medium"?"ğŸŸ  ë³´í†µ":"ğŸ”µ ë‚®ìŒ"}</button>))}
        </div>
        <div style={{display:"flex",gap:6,marginBottom:14,flexWrap:"wrap"}}>
          <button onClick={()=>setForm(f=>({...f,catId:null}))} style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${!form.catId?G.green:G.border}`,background:!form.catId?G.greenSoft:"#fff",color:!form.catId?G.green:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>ì—†ìŒ</button>
          {cats.map(c=>(<button key={c.id} onClick={()=>setForm(f=>({...f,catId:c.id}))} style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${form.catId===c.id?c.color:G.border}`,background:form.catId===c.id?`${c.color}18`:"#fff",color:form.catId===c.id?c.color:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>{c.icon} {c.label}</button>))}
        </div>
        <Btn variant="primary" style={{width:"100%"}} onClick={addTask}>ì¶”ê°€</Btn>
      </Modal>
    </div>
  );
}

function HabitView({ selectedDate, setSelectedDate, habits, setHabits, habitLog, setHabitLog }){
  const selStr = ds(selectedDate);
  const [subTab, setSubTab] = useState("today");
  const [showAddHabit, setShowAddHabit] = useState(false);
  const [editHabitId, setEditHabitId] = useState(null);
  const [hForm, setHForm] = useState({ title:"", icon:"â­", color:PALETTE[0], targetDays:[1,2,3,4,5,6,0] });

  function toggleHabit(habitId, dateStr) {
    setHabitLog(prev => {
      const day = { ...(prev[dateStr]||{}) };
      day[habitId] = !day[habitId];
      return { ...prev, [dateStr]: day };
    });
  }

  const todayDow = selectedDate.getDay();
  const todayHabits = habits.filter(h => h.targetDays.includes(todayDow));
  const doneCount = todayHabits.filter(h => habitLog[selStr]?.[h.id]).length;

  function getStreak(habitId) {
    let streak = 0;
    const d = new Date(TODAY);
    for(let i = 0; i < 365; i++) {
      const k = ds(d);
      const h = habits.find(x=>x.id===habitId);
      if(!h) break;
      if(!h.targetDays.includes(d.getDay())) { d.setDate(d.getDate()-1); continue; }
      if(habitLog[k]?.[habitId]) { streak++; d.setDate(d.getDate()-1); }
      else break;
    }
    return streak;
  }

  function getLast7(habitId) {
    return Array.from({length:7},(_,i)=>{
      const d=new Date(TODAY); d.setDate(d.getDate()-(6-i));
      const k=ds(d);
      const h=habits.find(x=>x.id===habitId);
      const applicable = h?.targetDays.includes(d.getDay());
      return { date:d, done: applicable ? !!habitLog[k]?.[habitId] : null, applicable };
    });
  }

  function openAddHabit(){ setEditHabitId(null); setHForm({title:"",icon:"â­",color:PALETTE[0],targetDays:[1,2,3,4,5,6,0]}); setShowAddHabit(true); }
  function openEditHabit(h){ setEditHabitId(h.id); setHForm({title:h.title,icon:h.icon,color:h.color,targetDays:[...h.targetDays]}); setShowAddHabit(true); }
  function saveHabit(){
    if(!hForm.title.trim()) return;
    if(editHabitId){ setHabits(p=>p.map(h=>h.id===editHabitId?{...h,...hForm}:h)); }
    else { setHabits(p=>[...p,{id:`hb_${Date.now()}`,...hForm}]); }
    setShowAddHabit(false);
  }
  function deleteHabit(id){ setHabits(p=>p.filter(h=>h.id!==id)); setShowAddHabit(false); }
  function toggleTargetDay(day){ setHForm(f=>({...f,targetDays:f.targetDays.includes(day)?f.targetDays.filter(d=>d!==day):[...f.targetDays,day]})); }

  const y=selectedDate.getFullYear(), m=selectedDate.getMonth();
  const monthDays=getDays(y,m);

  function prev(){ const d=new Date(selectedDate);d.setDate(d.getDate()-1);setSelectedDate(d); }
  function next(){ const d=new Date(selectedDate);d.setDate(d.getDate()+1);setSelectedDate(d); }

  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
        <button style={navBtnStyle} onClick={prev}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.textLight,fontSize:10,fontWeight:700,letterSpacing:1}}>{selectedDate.getFullYear()}.{String(selectedDate.getMonth()+1).padStart(2,"0")}</div>
          <div style={{color:G.text,fontSize:18,fontWeight:800}}>{selectedDate.getDate()}ì¼ {DAYS_KO[selectedDate.getDay()]}ìš”ì¼</div>
          {ds(selectedDate)===TODAY_STR && <div style={{fontSize:10,color:G.green,fontWeight:700,marginTop:2}}>ì˜¤ëŠ˜</div>}
        </div>
        <button style={navBtnStyle} onClick={next}>â€º</button>
      </div>

      <div style={{display:"flex",gap:6,marginBottom:20}}>
        {[{k:"today",l:"âœ… ì˜¤ëŠ˜"},{k:"stats",l:"ğŸ“Š í†µê³„"},{k:"manage",l:"âš™ï¸ ê´€ë¦¬"}].map(t=>(
          <button key={t.k} onClick={()=>setSubTab(t.k)} style={{flex:1,padding:"9px 0",borderRadius:14,border:"none",cursor:"pointer",fontSize:11,fontWeight:700,background:subTab===t.k?G.green:"#F0F4F8",color:subTab===t.k?"#fff":G.textMid,boxShadow:subTab===t.k?`0 3px 10px ${G.green}44`:"none",transition:"all 0.2s"}}>{t.l}</button>
        ))}
      </div>

      {subTab==="today" && (
        <div>
          <div style={{background:`linear-gradient(135deg,${G.green}18,${G.blue}10)`,borderRadius:20,padding:"16px 20px",marginBottom:18,display:"flex",alignItems:"center",gap:16,border:`1.5px solid ${G.greenMid}`}}>
            <div style={{position:"relative",width:64,height:64,flexShrink:0}}>
              <svg width="64" height="64" style={{transform:"rotate(-90deg)"}}>
                <circle cx="32" cy="32" r="26" fill="none" stroke={G.greenMid} strokeWidth="6"/>
                <circle cx="32" cy="32" r="26" fill="none" stroke={G.green} strokeWidth="6"
                  strokeDasharray={`${2*Math.PI*26}`}
                  strokeDashoffset={`${2*Math.PI*26*(1-(todayHabits.length>0?doneCount/todayHabits.length:0))}`}
                  strokeLinecap="round" style={{transition:"stroke-dashoffset 0.5s ease"}}/>
              </svg>
              <div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:900,color:G.green}}>
                {todayHabits.length>0?Math.round(doneCount/todayHabits.length*100):0}%
              </div>
            </div>
            <div>
              <div style={{fontSize:15,fontWeight:800,color:G.text}}>{doneCount}/{todayHabits.length} ì™„ë£Œ</div>
              <div style={{fontSize:11,color:G.textMid,marginTop:2}}>
                {doneCount===todayHabits.length&&todayHabits.length>0 ? "ğŸ‰ ì˜¤ëŠ˜ ëª¨ë“  ìŠµê´€ ë‹¬ì„±!" : "ê³„ì† í•´ë´ìš”!"}
              </div>
            </div>
          </div>

          {todayHabits.length===0 && (
            <div style={{textAlign:"center",padding:"28px 0",color:"#CBD5E0"}}>
              <div style={{fontSize:32,marginBottom:8}}>ğŸ˜´</div>
              <div style={{fontSize:13}}>ì˜¤ëŠ˜ì€ ì˜ˆì •ëœ ìŠµê´€ì´ ì—†ì–´ìš”</div>
            </div>
          )}

          {todayHabits.map(habit=>{
            const done = !!habitLog[selStr]?.[habit.id];
            const streak = getStreak(habit.id);
            const last7 = getLast7(habit.id);
            return (
              <div key={habit.id} onClick={()=>toggleHabit(habit.id,selStr)}
                style={{display:"flex",alignItems:"center",gap:14,padding:"14px 16px",marginBottom:10,borderRadius:18,cursor:"pointer",
                  background:done?`${habit.color}12`:"#fff",
                  border:`1.5px solid ${done?habit.color:G.border}`,
                  boxShadow:done?`0 4px 14px ${habit.color}22`:"0 2px 8px rgba(0,0,0,0.04)",
                  transition:"all 0.2s"}}>
                <div style={{width:44,height:44,borderRadius:22,flexShrink:0,
                  background:done?habit.color:`${habit.color}18`,
                  display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,
                  border:`2px solid ${done?habit.color:habit.color+"44"}`,
                  boxShadow:done?`0 3px 10px ${habit.color}44`:"none",
                  transition:"all 0.2s",position:"relative"}}>
                  {done ? <div style={{position:"absolute",inset:0,borderRadius:22,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,color:"#fff",fontWeight:900}}>âœ“</div> : habit.icon}
                </div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:14,fontWeight:700,color:done?G.textMid:G.text,textDecoration:done?"line-through":"none"}}>{habit.title}</div>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginTop:4}}>
                    {streak>0 && <span style={{fontSize:10,color:G.yellow,fontWeight:700}}>ğŸ”¥ {streak}ì¼ ì—°ì†</span>}
                    <div style={{display:"flex",gap:2}}>
                      {last7.map((d,i)=>(
                        <div key={i} style={{width:6,height:6,borderRadius:3,
                          background:d.applicable===false?"transparent":d.done?habit.color:`${habit.color}30`,
                          border:d.applicable===false?"none":`1px solid ${habit.color}55`}}/>
                      ))}
                    </div>
                  </div>
                </div>
                <div style={{fontSize:10,color:done?habit.color:G.textLight,fontWeight:700}}>{done?"ì™„ë£Œ":"ë¯¸ì™„"}</div>
              </div>
            );
          })}

          <button onClick={openAddHabit} style={{width:"100%",padding:"13px 0",marginTop:4,borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ ìŠµê´€ ì¶”ê°€</button>
        </div>
      )}

      {subTab==="stats" && (
        <div>
          <div style={{fontSize:11,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:12}}>ì´ë²ˆ ë‹¬ ìŠµê´€ íˆíŠ¸ë§µ</div>
          {habits.map(habit=>{
            const total = Array.from({length:monthDays},(_,i)=>{
              const dow=new Date(y,m,i+1).getDay();
              return habit.targetDays.includes(dow) ? 1 : 0;
            }).reduce((a,b)=>a+b,0);
            const done = Array.from({length:monthDays},(_,i)=>{
              const k=`${y}-${String(m+1).padStart(2,"0")}-${String(i+1).padStart(2,"0")}`;
              const dow=new Date(y,m,i+1).getDay();
              return habit.targetDays.includes(dow)&&habitLog[k]?.[habit.id] ? 1 : 0;
            }).reduce((a,b)=>a+b,0);
            const pct = total>0?Math.round(done/total*100):0;
            const streak = getStreak(habit.id);

            return (
              <div key={habit.id} style={{marginBottom:16,background:"#fff",borderRadius:18,padding:16,border:`1.5px solid ${habit.color}33`,boxShadow:"0 2px 8px rgba(0,0,0,0.04)"}}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <span style={{fontSize:20}}>{habit.icon}</span>
                    <span style={{fontSize:13,fontWeight:700,color:G.text}}>{habit.title}</span>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <div style={{fontSize:22,fontWeight:900,color:habit.color}}>{pct}%</div>
                    {streak>0 && <div style={{fontSize:9,color:G.yellow,fontWeight:700}}>ğŸ”¥ {streak}ì¼ ì—°ì†</div>}
                  </div>
                </div>
                <div style={{height:6,background:"#EDF2F7",borderRadius:3,marginBottom:10,overflow:"hidden"}}>
                  <div style={{height:"100%",width:`${pct}%`,background:habit.color,borderRadius:3,transition:"width 0.5s"}}/>
                </div>
                <div style={{display:"flex",flexWrap:"wrap",gap:3}}>
                  {Array.from({length:monthDays},(_,i)=>{
                    const day=i+1;
                    const k=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                    const dow=new Date(y,m,day).getDay();
                    const applicable=habit.targetDays.includes(dow);
                    const isDone=habitLog[k]?.[habit.id];
                    return (
                      <div key={day} title={`${day}ì¼`}
                        style={{width:14,height:14,borderRadius:3,
                          background:!applicable?"transparent":isDone?habit.color:`${habit.color}20`,
                          border:applicable?`1px solid ${habit.color}44`:"none"}}>
                        {!applicable && <div style={{width:14,height:14}}/>}
                      </div>
                    );
                  })}
                </div>
                <div style={{marginTop:6,fontSize:10,color:G.textLight}}>{done}/{total}ì¼ ì™„ë£Œ</div>
              </div>
            );
          })}
        </div>
      )}

      {subTab==="manage" && (
        <div>
          {habits.map(h=>(
            <div key={h.id} style={{display:"flex",alignItems:"center",gap:12,padding:"12px 0",borderBottom:`1px solid ${G.borderLight}`}}>
              <div style={{width:40,height:40,borderRadius:12,background:`${h.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,border:`2px solid ${h.color}33`}}>{h.icon}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:13,fontWeight:700,color:G.text}}>{h.title}</div>
                <div style={{display:"flex",gap:3,marginTop:3}}>
                  {[0,1,2,3,4,5,6].map(d=>(
                    <span key={d} style={{fontSize:9,padding:"1px 4px",borderRadius:4,fontWeight:700,background:h.targetDays.includes(d)?`${h.color}22`:G.borderLight,color:h.targetDays.includes(d)?h.color:G.textLight}}>{DAYS_KO[d]}</span>
                  ))}
                </div>
              </div>
              <Btn small variant="neutral" onClick={()=>openEditHabit(h)}>âœï¸ ìˆ˜ì •</Btn>
            </div>
          ))}
          <button onClick={openAddHabit} style={{width:"100%",padding:"14px 0",marginTop:12,borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ ìŠµê´€ ì¶”ê°€</button>
        </div>
      )}

      <Modal show={showAddHabit} onClose={()=>setShowAddHabit(false)} title={editHabitId?"ìŠµê´€ ìˆ˜ì •":"ìƒˆ ìŠµê´€ ì¶”ê°€"}>
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          <input value={hForm.icon} onChange={e=>setHForm(f=>({...f,icon:e.target.value}))} style={{...inp(),width:56,marginBottom:0,textAlign:"center",fontSize:22,padding:"8px"}} maxLength={2}/>
          <input value={hForm.title} onChange={e=>setHForm(f=>({...f,title:e.target.value}))} placeholder="ìŠµê´€ ì´ë¦„" style={{...inp(),flex:1,marginBottom:0}}/>
        </div>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14,marginTop:12}}>
          {PALETTE.map(clr=>(<div key={clr} onClick={()=>setHForm(f=>({...f,color:clr}))} style={{width:26,height:26,borderRadius:13,background:clr,cursor:"pointer",boxShadow:hForm.color===clr?`0 0 0 3px white,0 0 0 5px ${clr}`:"none"}}/>))}
        </div>
        <div style={{color:G.textLight,fontSize:10,fontWeight:700,marginBottom:8,letterSpacing:1}}>ì‹¤í–‰ ìš”ì¼</div>
        <div style={{display:"flex",gap:4,marginBottom:20}}>
          {[0,1,2,3,4,5,6].map(day=>(<button key={day} onClick={()=>toggleTargetDay(day)} style={{flex:1,padding:"9px 0",borderRadius:10,border:`1.5px solid ${hForm.targetDays.includes(day)?G.green:G.border}`,background:hForm.targetDays.includes(day)?G.greenSoft:"#fff",color:hForm.targetDays.includes(day)?G.greenDark:day===0?G.red:day===6?G.blue:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>{DAYS_KO[day]}</button>))}
        </div>
        <div style={{display:"flex",gap:8}}>
          {editHabitId && <Btn variant="danger" style={{flex:1}} onClick={()=>deleteHabit(editHabitId)}>ì‚­ì œ</Btn>}
          <Btn variant="primary" style={{flex:2}} onClick={saveHabit}>ì €ì¥</Btn>
        </div>
      </Modal>
    </div>
  );
}

function BudgetView({ selectedDate, setSelectedDate, budget, setBudget }){
  const selStr = ds(selectedDate);
  const [subTab, setSubTab] = useState("daily");

  // form: type, amount, category, place(ì§€ì¶œì²˜), items(í’ˆëª© ë°°ì—´), memo
  const EMPTY_FORM = { type:"expense", amount:"", category:"ì‹ë¹„", place:"", items:[{name:"",price:""}], memo:"" };
  const [showAdd, setShowAdd] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState(EMPTY_FORM);
  const [expandedId, setExpandedId] = useState(null);

  const fmtAmt = n => n.toLocaleString()+"ì›";
  const catColors = {"ì‹ë¹„":"#F97316","êµí†µ":"#4A90E2","ì¹´í˜":"#F5A623","ì‡¼í•‘":"#EC4899","ì˜ë£Œ":"#F05252","ë¬¸í™”":"#A855F7","êµ¬ë…":"#14B8A6","ê¸°íƒ€":"#94A3B8","ê¸‰ì—¬":"#2DB87A","ë¶€ì—…":"#2DB87A","ìš©ëˆ":"#2DB87A","íˆ¬ììˆ˜ìµ":"#2DB87A"};
  const catIcon = c => c==="ì‹ë¹„"?"ğŸ½ï¸":c==="êµí†µ"?"ğŸšŒ":c==="ì¹´í˜"?"â˜•":c==="ì‡¼í•‘"?"ğŸ›ï¸":c==="ì˜ë£Œ"?"ğŸ’Š":c==="ë¬¸í™”"?"ğŸ¬":c==="êµ¬ë…"?"ğŸ“±":"ğŸ’³";

  function prev(){ const d=new Date(selectedDate);d.setDate(d.getDate()-1);setSelectedDate(d); }
  function next(){ const d=new Date(selectedDate);d.setDate(d.getDate()+1);setSelectedDate(d); }

  function openAdd(){
    setEditId(null); setForm(EMPTY_FORM); setShowAdd(true);
  }
  function openEdit(entry){
    setEditId(entry.id);
    setForm({
      type: entry.type,
      amount: String(entry.amount),
      category: entry.category,
      place: entry.place||"",
      items: entry.items?.length ? entry.items.map(i=>({...i})) : [{name:"",price:""}],
      memo: entry.memo||entry.note||"",
    });
    setShowAdd(true);
  }

  // í’ˆëª© ìë™í•©ì‚° â†’ ê¸ˆì•¡ í•„ë“œì— ë°˜ì˜
  function updateItem(i, field, val){
    setForm(f=>{
      const items = f.items.map((it,idx)=>idx===i?{...it,[field]:val}:it);
      const total = items.reduce((a,it)=>a+(parseInt(it.price||0,10)||0),0);
      return {...f, items, amount: total>0 ? String(total) : f.amount};
    });
  }
  function addItem(){ setForm(f=>({...f,items:[...f.items,{name:"",price:""}]})); }
  function removeItem(i){ setForm(f=>({...f,items:f.items.filter((_,idx)=>idx!==i)})); }

  function saveEntry(){
    const amt = parseInt(String(form.amount).replace(/,/g,""),10);
    if(!amt||amt<=0) return;
    const entry = {
      id: editId||Date.now(),
      type: form.type,
      amount: amt,
      category: form.category,
      place: form.place.trim(),
      items: form.items.filter(it=>it.name.trim()||it.price),
      memo: form.memo.trim(),
      // í•˜ìœ„í˜¸í™˜
      note: [form.place, form.memo].filter(Boolean).join(" "),
    };
    setBudget(p=>{
      const list = [...(p[selStr]||[])];
      if(editId){ const i=list.findIndex(e=>e.id===editId); if(i>=0) list[i]=entry; }
      else list.push(entry);
      return {...p,[selStr]:list};
    });
    setShowAdd(false);
  }
  function deleteEntry(dateStr,id){
    setBudget(p=>({...p,[dateStr]:(p[dateStr]||[]).filter(e=>e.id!==id)}));
    if(expandedId===id) setExpandedId(null);
    setShowAdd(false);
  }

  const dayEntries = budget[selStr]||[];
  const dayIncome  = dayEntries.filter(e=>e.type==="income").reduce((a,e)=>a+e.amount,0);
  const dayExpense = dayEntries.filter(e=>e.type==="expense").reduce((a,e)=>a+e.amount,0);
  const dayBalance = dayIncome-dayExpense;

  const y=selectedDate.getFullYear(), m=selectedDate.getMonth();
  const monthDays=getDays(y,m);
  let monthIncome=0, monthExpense=0; const monthCatMap={};
  for(let i=1;i<=monthDays;i++){
    const k=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    (budget[k]||[]).forEach(e=>{
      if(e.type==="income") monthIncome+=e.amount;
      else { monthExpense+=e.amount; monthCatMap[e.category]=(monthCatMap[e.category]||0)+e.amount; }
    });
  }
  const monthBalance=monthIncome-monthExpense;
  const last7=Array.from({length:7},(_,i)=>{ const d=new Date(TODAY); d.setDate(d.getDate()-(6-i)); const k=ds(d); return {label:`${d.getMonth()+1}/${d.getDate()}`,dayLabel:DAYS_KO[d.getDay()],expense:(budget[k]||[]).filter(e=>e.type==="expense").reduce((a,e)=>a+e.amount,0)}; });
  const maxSpend=Math.max(...last7.map(d=>d.expense),1);

  // í’ˆëª© ìë™í•©ì‚° ë¯¸ë¦¬ë³´ê¸°
  const itemsTotal = form.items.reduce((a,it)=>a+(parseInt(it.price||0,10)||0),0);

  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <button style={navBtnStyle} onClick={prev}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.textLight,fontSize:10,fontWeight:700}}>{y}ë…„ {MONTHS_KO[m]}</div>
          <div style={{color:G.text,fontSize:18,fontWeight:800}}>{selectedDate.getDate()}ì¼ {DAYS_KO[selectedDate.getDay()]}ìš”ì¼</div>
        </div>
        <button style={navBtnStyle} onClick={next}>â€º</button>
      </div>

      <div style={{display:"flex",gap:6,marginBottom:16}}>
        {[{k:"daily",l:"ğŸ“… ì¼ë³„"},{k:"monthly",l:"ğŸ“Š ì›”ê°„"},{k:"chart",l:"ğŸ“ˆ ì°¨íŠ¸"}].map(t=>(
          <button key={t.k} onClick={()=>setSubTab(t.k)} style={{flex:1,padding:"9px 0",borderRadius:14,border:"none",cursor:"pointer",fontSize:11,fontWeight:700,background:subTab===t.k?G.green:"#F0F4F8",color:subTab===t.k?"#fff":G.textMid,boxShadow:subTab===t.k?`0 3px 10px ${G.green}44`:"none",transition:"all 0.2s"}}>{t.l}</button>
        ))}
      </div>

      {/* â”€â”€ ì¼ë³„ íƒ­ â”€â”€ */}
      {subTab==="daily" && (
        <div>
          {/* ìš”ì•½ ì¹´ë“œ */}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:14}}>
            {[{label:"ìˆ˜ì…",value:dayIncome,color:G.green},{label:"ì§€ì¶œ",value:dayExpense,color:G.red},{label:"ì”ì•¡",value:dayBalance,color:dayBalance>=0?G.blue:G.red}].map(s=>(
              <div key={s.label} style={{background:"#fff",borderRadius:14,padding:"12px 8px",textAlign:"center",border:`1.5px solid ${s.color}22`,boxShadow:"0 2px 6px rgba(0,0,0,0.04)"}}>
                <div style={{fontSize:9,fontWeight:700,color:G.textLight,marginBottom:3}}>{s.label}</div>
                <div style={{fontSize:12,fontWeight:900,color:s.color,wordBreak:"break-all"}}>{s.value!==0?(s.value>0?"+":"")+fmtAmt(s.value):"0ì›"}</div>
              </div>
            ))}
          </div>

          {dayEntries.length===0 ? (
            <div style={{textAlign:"center",padding:"32px 0",color:"#CBD5E0"}}>
              <div style={{fontSize:40,marginBottom:8}}>ğŸ’¸</div>
              <div style={{fontSize:13}}>ì˜¤ëŠ˜ ë‚´ì—­ì´ ì—†ì–´ìš”</div>
            </div>
          ) : (
            [...dayEntries].sort((a,b)=>a.type==="income"?-1:1).map(entry=>{
              const isExpanded = expandedId===entry.id;
              const hasDetail = entry.place||(entry.items&&entry.items.length>0)||entry.memo;
              return (
                <div key={entry.id} style={{marginBottom:8,borderRadius:16,overflow:"hidden",border:`1.5px solid ${isExpanded?(catColors[entry.category]||G.border):G.border}`,background:"#fff",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",transition:"border-color 0.2s"}}>
                  {/* ë©”ì¸ í–‰ */}
                  <div style={{display:"flex",alignItems:"center",gap:10,padding:"12px 14px",cursor:"pointer"}}
                    onClick={()=>setExpandedId(isExpanded?null:entry.id)}>
                    <div style={{width:40,height:40,borderRadius:12,background:`${catColors[entry.category]||"#94A3B8"}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,flexShrink:0,border:`1.5px solid ${catColors[entry.category]||"#94A3B8"}30`}}>
                      {entry.type==="income"?"ğŸ’°":catIcon(entry.category)}
                    </div>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{display:"flex",alignItems:"center",gap:6}}>
                        <span style={{fontSize:13,fontWeight:700,color:G.text}}>{entry.category}</span>
                        {entry.place && <span style={{fontSize:11,color:G.textMid,fontWeight:500}}>Â· {entry.place}</span>}
                      </div>
                      {entry.items?.filter(it=>it.name).length>0 && (
                        <div style={{fontSize:10,color:G.textLight,marginTop:2,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>
                          {entry.items.filter(it=>it.name).map(it=>it.name).join(", ")}
                        </div>
                      )}
                      {!entry.items?.filter(it=>it.name).length && entry.memo && (
                        <div style={{fontSize:10,color:G.textLight,marginTop:2}}>{entry.memo}</div>
                      )}
                    </div>
                    <div style={{textAlign:"right",flexShrink:0}}>
                      <div style={{fontSize:14,fontWeight:900,color:entry.type==="income"?G.green:G.red}}>
                        {entry.type==="income"?"+":"-"}{fmtAmt(entry.amount)}
                      </div>
                      {hasDetail && <div style={{fontSize:9,color:G.textLight,marginTop:2}}>{isExpanded?"â–² ì ‘ê¸°":"â–¼ ìƒì„¸"}</div>}
                    </div>
                  </div>

                  {/* ìƒì„¸ í¼ì¹¨ */}
                  {isExpanded && (
                    <div style={{padding:"0 14px 14px",borderTop:`1px solid ${G.borderLight}`,paddingTop:12}}>
                      {entry.place && (
                        <div style={{display:"flex",gap:8,marginBottom:8,alignItems:"center"}}>
                          <span style={{fontSize:10,fontWeight:700,color:G.textLight,minWidth:42}}>ğŸ“ ì§€ì¶œì²˜</span>
                          <span style={{fontSize:13,fontWeight:600,color:G.text,background:"#F7FAFC",borderRadius:8,padding:"4px 10px"}}>{entry.place}</span>
                        </div>
                      )}
                      {entry.items?.filter(it=>it.name).length>0 && (
                        <div style={{marginBottom:8}}>
                          <div style={{fontSize:10,fontWeight:700,color:G.textLight,marginBottom:6}}>ğŸ§¾ í’ˆëª©ë‚´ì—­</div>
                          <div style={{background:"#F7FAFC",borderRadius:12,overflow:"hidden"}}>
                            {entry.items.filter(it=>it.name).map((it,i)=>(
                              <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderBottom:i<entry.items.filter(x=>x.name).length-1?`1px solid ${G.borderLight}`:"none"}}>
                                <span style={{fontSize:12,fontWeight:500,color:G.text}}>{it.name}</span>
                                {it.price && <span style={{fontSize:12,fontWeight:700,color:G.red}}>{parseInt(it.price,10).toLocaleString()}ì›</span>}
                              </div>
                            ))}
                            <div style={{display:"flex",justifyContent:"space-between",padding:"8px 12px",background:`${G.red}08`,borderTop:`1px solid ${G.border}`}}>
                              <span style={{fontSize:11,fontWeight:700,color:G.textMid}}>í•©ê³„</span>
                              <span style={{fontSize:13,fontWeight:900,color:G.red}}>{fmtAmt(entry.amount)}</span>
                            </div>
                          </div>
                        </div>
                      )}
                      {entry.memo && (
                        <div style={{display:"flex",gap:8,alignItems:"flex-start",marginBottom:8}}>
                          <span style={{fontSize:10,fontWeight:700,color:G.textLight,minWidth:42}}>ğŸ“ ë©”ëª¨</span>
                          <span style={{fontSize:12,color:G.textMid,flex:1}}>{entry.memo}</span>
                        </div>
                      )}
                      <div style={{display:"flex",gap:8,marginTop:4}}>
                        <button onClick={()=>openEdit(entry)} style={{flex:1,padding:"8px 0",borderRadius:10,background:G.greenSoft,border:`1.5px solid ${G.greenMid}`,color:G.green,fontSize:12,fontWeight:700,cursor:"pointer"}}>âœï¸ ìˆ˜ì •</button>
                        <button onClick={()=>deleteEntry(selStr,entry.id)} style={{flex:1,padding:"8px 0",borderRadius:10,background:"#FFF5F5",border:"1.5px solid #FEB2B2",color:G.red,fontSize:12,fontWeight:700,cursor:"pointer"}}>ğŸ—‘ ì‚­ì œ</button>
                      </div>
                    </div>
                  )}
                </div>
              );
            })
          )}
          <button onClick={openAdd} style={{width:"100%",padding:"13px 0",marginTop:8,borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ ë‚´ì—­ ì¶”ê°€</button>
        </div>
      )}

      {/* â”€â”€ ì›”ê°„ íƒ­ â”€â”€ */}
      {subTab==="monthly" && (
        <div>
          <div style={{background:`linear-gradient(135deg,${G.green}18,${G.blue}10)`,borderRadius:20,padding:20,marginBottom:16,border:`1.5px solid ${G.greenMid}`}}>
            <div style={{fontSize:11,fontWeight:800,color:G.textMid,letterSpacing:1,marginBottom:12}}>{y}ë…„ {MONTHS_KO[m]} ìš”ì•½</div>
            <div style={{display:"flex",gap:20,marginBottom:10}}>
              <div><div style={{fontSize:10,color:G.textLight}}>ì´ ìˆ˜ì…</div><div style={{fontSize:20,fontWeight:900,color:G.green}}>+{fmtAmt(monthIncome)}</div></div>
              <div><div style={{fontSize:10,color:G.textLight}}>ì´ ì§€ì¶œ</div><div style={{fontSize:20,fontWeight:900,color:G.red}}>-{fmtAmt(monthExpense)}</div></div>
            </div>
            <div style={{fontSize:13,fontWeight:700,color:monthBalance>=0?G.blue:G.red}}>ì”ì•¡ {monthBalance>=0?"+":""}{fmtAmt(monthBalance)}</div>
          </div>
          <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:10}}>ì§€ì¶œ ì¹´í…Œê³ ë¦¬</div>
          {Object.entries(monthCatMap).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>(
            <div key={cat} style={{display:"flex",alignItems:"center",gap:10,marginBottom:8}}>
              <div style={{width:32,height:32,borderRadius:10,background:`${catColors[cat]||"#94A3B8"}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,flexShrink:0}}>{catIcon(cat)}</div>
              <div style={{flex:1}}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                  <span style={{fontSize:12,fontWeight:600,color:G.text}}>{cat}</span>
                  <span style={{fontSize:12,fontWeight:700,color:G.red}}>-{fmtAmt(amt)}</span>
                </div>
                <div style={{height:5,background:"#EDF2F7",borderRadius:3,overflow:"hidden"}}>
                  <div style={{height:"100%",width:`${monthExpense>0?Math.round(amt/monthExpense*100):0}%`,background:catColors[cat]||"#94A3B8",borderRadius:3}}/>
                </div>
              </div>
              <span style={{fontSize:10,color:G.textLight,minWidth:28}}>{monthExpense>0?Math.round(amt/monthExpense*100):0}%</span>
            </div>
          ))}
          {Object.keys(monthCatMap).length===0&&<div style={{textAlign:"center",color:"#CBD5E0",fontSize:13,paddingTop:16}}>ì´ë²ˆ ë‹¬ ì§€ì¶œì´ ì—†ì–´ìš”</div>}
        </div>
      )}

      {/* â”€â”€ ì°¨íŠ¸ íƒ­ â”€â”€ */}
      {subTab==="chart" && (
        <div>
          <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:14}}>ìµœê·¼ 7ì¼ ì§€ì¶œ</div>
          <div style={{display:"flex",alignItems:"flex-end",gap:6,height:120,marginBottom:8}}>
            {last7.map((d,i)=>(
              <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:3}}>
                <div style={{fontSize:8,color:G.textLight,fontWeight:600,whiteSpace:"nowrap"}}>{d.expense>0?`${Math.round(d.expense/1000)}k`:""}</div>
                <div style={{width:"100%",borderRadius:"4px 4px 0 0",transition:"height 0.5s ease",background:d.expense>0?`linear-gradient(180deg,${G.red}cc,${G.red}88)`:"#EDF2F7",height:`${d.expense>0?Math.max(8,Math.round(d.expense/maxSpend*80)):4}px`}}/>
              </div>
            ))}
          </div>
          <div style={{display:"flex",gap:6,marginBottom:20}}>
            {last7.map((d,i)=>(<div key={i} style={{flex:1,textAlign:"center"}}><div style={{fontSize:9,color:G.textLight,fontWeight:600}}>{d.dayLabel}</div></div>))}
          </div>
          <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:10}}>ì´ë²ˆ ë‹¬ ì§€ì¶œ íˆíŠ¸ë§µ</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
            {Array.from({length:getFirst(y,m)}).map((_,i)=>(<div key={`e${i}`} style={{width:32,height:32}}/>))}
            {Array.from({length:monthDays},(_,i)=>{
              const day=i+1;
              const k=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
              const exp=(budget[k]||[]).filter(e=>e.type==="expense").reduce((a,e)=>a+e.amount,0);
              const maxMonth=Math.max(...Array.from({length:monthDays},(_,j)=>{ const kk=`${y}-${String(m+1).padStart(2,"0")}-${String(j+1).padStart(2,"0")}`; return (budget[kk]||[]).filter(e=>e.type==="expense").reduce((a,e)=>a+e.amount,0);}),1);
              const intensity=exp>0?Math.max(0.15,exp/maxMonth):0;
              const isToday=k===TODAY_STR; const isSel=k===selStr; const dow=new Date(y,m,day).getDay();
              return (
                <div key={day} onClick={()=>setSelectedDate(new Date(y,m,day))} style={{width:32,height:32,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",background:exp>0?`rgba(240,82,82,${intensity})`:"#F7FAFC",border:isSel?`2px solid ${G.green}`:isToday?`2px solid ${G.green}88`:`1px solid ${G.borderLight}`,boxSizing:"border-box"}}>
                  <span style={{fontSize:10,fontWeight:isSel||isToday?800:400,color:isSel?G.green:dow===0?G.red:dow===6?G.blue:G.textMid}}>{day}</span>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* â”€â”€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ â”€â”€ */}
      <Modal show={showAdd} onClose={()=>setShowAdd(false)} title={editId?"ë‚´ì—­ ìˆ˜ì •":"ë‚´ì—­ ì¶”ê°€"}>
        {/* ìˆ˜ì…/ì§€ì¶œ í† ê¸€ */}
        <div style={{display:"flex",gap:8,marginBottom:16}}>
          {["expense","income"].map(t=>(
            <button key={t} onClick={()=>setForm(f=>({...f,type:t,category:t==="expense"?"ì‹ë¹„":"ê¸‰ì—¬"}))}
              style={{flex:1,padding:"11px 0",borderRadius:14,border:`1.5px solid ${form.type===t?(t==="expense"?G.red:G.green):G.border}`,background:form.type===t?(t==="expense"?"#FFF5F5":G.greenSoft):"#fff",color:form.type===t?(t==="expense"?G.red:G.green):G.textLight,fontSize:13,fontWeight:800,cursor:"pointer"}}>
              {t==="expense"?"ğŸ’¸ ì§€ì¶œ":"ğŸ’° ìˆ˜ì…"}
            </button>
          ))}
        </div>

        {/* ì¹´í…Œê³ ë¦¬ */}
        <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:7}}>ì¹´í…Œê³ ë¦¬</div>
        <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:14}}>
          {(form.type==="expense"?BUDGET_EXPENSE_CATS:BUDGET_INCOME_CATS).map(cat=>(
            <button key={cat} onClick={()=>setForm(f=>({...f,category:cat}))}
              style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${form.category===cat?(catColors[cat]||G.green):G.border}`,background:form.category===cat?`${catColors[cat]||G.green}18`:"#fff",color:form.category===cat?(catColors[cat]||G.green):G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>
              {catIcon(cat)} {cat}
            </button>
          ))}
        </div>

        {/* ì§€ì¶œì²˜ (ì§€ì¶œì¼ ë•Œë§Œ) */}
        {form.type==="expense" && (
          <>
            <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:6}}>ğŸ“ ì§€ì¶œì²˜</div>
            <input value={form.place} onChange={e=>setForm(f=>({...f,place:e.target.value}))}
              placeholder="ì˜ˆ: ì´ë§ˆíŠ¸, ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì " style={{...inp(),marginBottom:14}}/>
          </>
        )}

        {/* í’ˆëª©ë‚´ì—­ (ì§€ì¶œì¼ ë•Œë§Œ) */}
        {form.type==="expense" && (
          <div style={{marginBottom:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
              <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1}}>ğŸ§¾ í’ˆëª©ë‚´ì—­</div>
              {itemsTotal>0 && <div style={{fontSize:10,fontWeight:700,color:G.red}}>í•©ê³„ {fmtAmt(itemsTotal)}</div>}
            </div>
            {form.items.map((it,i)=>(
              <div key={i} style={{display:"grid",gridTemplateColumns:"1fr 100px 28px",gap:6,marginBottom:7,alignItems:"center"}}>
                <input value={it.name} onChange={e=>updateItem(i,"name",e.target.value)}
                  placeholder={`í’ˆëª© ${i+1}`} style={{...inp(),marginBottom:0,fontSize:12}}/>
                <div style={{position:"relative"}}>
                  <input type="number" value={it.price} onChange={e=>updateItem(i,"price",e.target.value)}
                    placeholder="ê¸ˆì•¡" style={{...inp(),marginBottom:0,fontSize:12,paddingRight:20,textAlign:"right"}}/>
                  <span style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",fontSize:9,color:G.textLight}}>ì›</span>
                </div>
                <button onClick={()=>removeItem(i)} style={{width:28,height:36,borderRadius:8,background:"#FFF5F5",border:"none",cursor:"pointer",color:G.red,fontSize:14,display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
              </div>
            ))}
            <button onClick={addItem} style={{width:"100%",padding:"7px 0",borderRadius:10,border:`1.5px dashed ${G.border}`,background:"transparent",color:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>+ í’ˆëª© ì¶”ê°€</button>
          </div>
        )}

        {/* ê¸ˆì•¡ (ì§ì ‘ ì…ë ¥ or í’ˆëª© í•©ì‚°) */}
        <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:6}}>
          {form.type==="expense"?"ğŸ’° ì´ ê¸ˆì•¡":"ğŸ’° ê¸ˆì•¡"}
          {form.type==="expense" && itemsTotal>0 && <span style={{color:G.green,marginLeft:6}}>(í’ˆëª© ìë™ í•©ì‚°ë¨)</span>}
        </div>
        <div style={{position:"relative",marginBottom:14}}>
          <input type="number" value={form.amount} onChange={e=>setForm(f=>({...f,amount:e.target.value}))}
            placeholder="ê¸ˆì•¡" style={{...inp(),marginBottom:0,paddingRight:36,fontSize:16,fontWeight:700}}/>
          <span style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",fontSize:13,color:G.textLight}}>ì›</span>
        </div>

        {/* ë©”ëª¨ */}
        <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:6}}>ğŸ“ ë©”ëª¨</div>
        <input value={form.memo} onChange={e=>setForm(f=>({...f,memo:e.target.value}))}
          placeholder="ì¶”ê°€ ë©”ëª¨ (ì„ íƒ)" style={{...inp(),marginBottom:16}}/>

        <div style={{display:"flex",gap:8}}>
          {editId && <Btn variant="danger" style={{flex:1}} onClick={()=>deleteEntry(selStr,editId)}>ì‚­ì œ</Btn>}
          <Btn variant="primary" style={{flex:2}} onClick={saveEntry}>ì €ì¥</Btn>
        </div>
      </Modal>
    </div>
  );
}

function HealthView({ selectedDate, setSelectedDate, weightLog, setWeightLog, dietLog, setDietLog, workoutLog, setWorkoutLog, mealCats, setMealCats }) {
  const selStr = ds(selectedDate);
  const [subTab, setSubTab] = useState("workout");

  const [showAddWorkout, setShowAddWorkout] = useState(false);
  const [editWorkoutId, setEditWorkoutId] = useState(null);
  const [woForm, setWoForm] = useState({ type:"í—¬ìŠ¤/ì›¨ì´íŠ¸", duration:"", note:"", sets:[{exercise:"",reps:"",weight:""}] });

  const [showWeightInput, setShowWeightInput] = useState(false);
  const [wForm, setWForm] = useState("");

  const [showAddDiet, setShowAddDiet] = useState(false);
  const [dForm, setDForm] = useState({ meal:"", foods:"" });
  const [showMealCatMgr, setShowMealCatMgr] = useState(false);
  const [catMgrForm, setCatMgrForm] = useState({ label:"", icon:"ğŸ½ï¸" });
  const [editCatId, setEditCatId] = useState(null);

  function prev(){ const d=new Date(selectedDate);d.setDate(d.getDate()-1);setSelectedDate(d); }
  function next(){ const d=new Date(selectedDate);d.setDate(d.getDate()+1);setSelectedDate(d); }

  const todayWeight = weightLog[selStr];
  function saveWeight(){
    const v = parseFloat(wForm);
    if(!v||v<=0) return;
    setWeightLog(p=>({...p,[selStr]:v}));
    setShowWeightInput(false); setWForm("");
  }
  const last14Weight = Array.from({length:14},(_,i)=>{
    const d=new Date(TODAY); d.setDate(d.getDate()-(13-i));
    return { label:`${d.getDate()}`, val: weightLog[ds(d)]||null, date: ds(d) };
  });
  const wVals = last14Weight.map(d=>d.val).filter(Boolean);
  const wMin = wVals.length ? Math.min(...wVals)-1 : 60;
  const wMax = wVals.length ? Math.max(...wVals)+1 : 80;

  const todayDiet = dietLog[selStr]||[];
  function saveDiet(){
    if(!dForm.foods.trim()||!dForm.meal) return;
    setDietLog(p=>({...p,[selStr]:[...(p[selStr]||[]),{id:Date.now(),meal:dForm.meal,foods:dForm.foods}]}));
    setDForm({meal:"",foods:""}); setShowAddDiet(false);
  }
  function deleteDiet(id){ setDietLog(p=>({...p,[selStr]:(p[selStr]||[]).filter(d=>d.id!==id)})); }

  function openAddCat(){ setEditCatId(null); setCatMgrForm({label:"",icon:"ğŸ½ï¸"}); }
  function openEditCat(c){ setEditCatId(c.id); setCatMgrForm({label:c.label,icon:c.icon}); }
  function saveCat(){
    if(!catMgrForm.label.trim()) return;
    if(editCatId){
      setMealCats(p=>p.map(c=>c.id===editCatId?{...c,...catMgrForm}:c));
    } else {
      setMealCats(p=>[...p,{id:`mc_${Date.now()}`,label:catMgrForm.label,icon:catMgrForm.icon}]);
    }
    setEditCatId(null); setCatMgrForm({label:"",icon:"ğŸ½ï¸"});
  }
  function deleteCat(id){
    setMealCats(p=>p.filter(c=>c.id!==id));
    setDietLog(p=>{
      const next={...p};
      Object.keys(next).forEach(k=>{ next[k]=(next[k]||[]).filter(e=>e.meal!==id); });
      return next;
    });
  }

  const todayWorkouts = workoutLog[selStr]||[];
  function addSet(){ setWoForm(f=>({...f,sets:[...f.sets,{exercise:"",reps:"",weight:""}]})); }
  function updateSet(i,field,val){ setWoForm(f=>({...f,sets:f.sets.map((s,idx)=>idx===i?{...s,[field]:val}:s)})); }
  function removeSet(i){ setWoForm(f=>({...f,sets:f.sets.filter((_,idx)=>idx!==i)})); }
  function openAddWorkout(){
    setEditWorkoutId(null);
    setWoForm({type:"í—¬ìŠ¤/ì›¨ì´íŠ¸",duration:"",note:"",sets:[{exercise:"",reps:"",weight:""}]});
    setShowAddWorkout(true);
  }
  function openEditWorkout(w){
    setEditWorkoutId(w.id);
    setWoForm({type:w.type,duration:String(w.duration),note:w.note,sets:w.sets.length?w.sets.map(s=>({...s})):[{exercise:"",reps:"",weight:""}]});
    setShowAddWorkout(true);
  }
  function saveWorkout(){
    if(!woForm.type) return;
    const entry = { id:editWorkoutId||Date.now(), type:woForm.type, duration:parseInt(woForm.duration)||0, note:woForm.note, sets:woForm.sets.filter(s=>s.exercise.trim()) };
    setWorkoutLog(p=>{
      const list = [...(p[selStr]||[])];
      if(editWorkoutId){ const i=list.findIndex(w=>w.id===editWorkoutId); if(i>=0) list[i]=entry; }
      else list.push(entry);
      return {...p,[selStr]:list};
    });
    setShowAddWorkout(false);
  }
  function deleteWorkout(id){ setWorkoutLog(p=>({...p,[selStr]:(p[selStr]||[]).filter(w=>w.id!==id)})); }

  const y=selectedDate.getFullYear(), m=selectedDate.getMonth();
  const monthDays=getDays(y,m);
  const SPORT_ICONS = {"í—¬ìŠ¤/ì›¨ì´íŠ¸":"ğŸ‹ï¸","ëŸ¬ë‹":"ğŸƒ","ìˆ˜ì˜":"ğŸŠ","ìì „ê±°":"ğŸš´","í•„ë¼í…ŒìŠ¤":"ğŸ§˜","ìš”ê°€":"ğŸ§˜","í´ë¼ì´ë°":"ğŸ§—","HIIT":"âš¡","ìŠ¤íŠ¸ë ˆì¹­":"ğŸŒ¿","ê¸°íƒ€":"ğŸ’ª"};

  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <button style={navBtnStyle} onClick={prev}>â€¹</button>
        <div style={{textAlign:"center"}}>
          <div style={{color:G.textLight,fontSize:10,fontWeight:700}}>{y}ë…„ {MONTHS_KO[m]}</div>
          <div style={{color:G.text,fontSize:18,fontWeight:800}}>{selectedDate.getDate()}ì¼ {DAYS_KO[selectedDate.getDay()]}ìš”ì¼</div>
          {selStr===TODAY_STR && <div style={{fontSize:10,color:G.green,fontWeight:700}}>ì˜¤ëŠ˜</div>}
        </div>
        <button style={navBtnStyle} onClick={next}>â€º</button>
      </div>

      <div style={{display:"flex",gap:6,marginBottom:18}}>
        {[{k:"workout",l:"ğŸ‹ï¸ ìš´ë™"},{k:"weight",l:"âš–ï¸ ëª¸ë¬´ê²Œ"},{k:"diet",l:"ğŸ¥— ì‹ë‹¨"}].map(t=>(
          <button key={t.k} onClick={()=>setSubTab(t.k)} style={{flex:1,padding:"9px 0",borderRadius:14,border:"none",cursor:"pointer",fontSize:11,fontWeight:700,
            background:subTab===t.k?G.green:"#F0F4F8",color:subTab===t.k?"#fff":G.textMid,
            boxShadow:subTab===t.k?`0 3px 10px ${G.green}44`:"none",transition:"all 0.2s"}}>{t.l}</button>
        ))}
      </div>

      {subTab==="workout" && (
        <div>
          {todayWorkouts.length===0 ? (
            <div style={{textAlign:"center",padding:"28px 0",color:"#CBD5E0"}}>
              <div style={{fontSize:40,marginBottom:8}}>ğŸ‹ï¸</div>
              <div style={{fontSize:13,fontWeight:600}}>ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ì´ ì—†ì–´ìš”</div>
            </div>
          ) : (
            todayWorkouts.map(w=>(
              <div key={w.id} style={{marginBottom:14,background:"#fff",borderRadius:18,overflow:"hidden",border:`1.5px solid ${G.border}`,boxShadow:"0 2px 10px rgba(0,0,0,0.05)"}}>
                <div style={{padding:"14px 16px 10px",background:`linear-gradient(135deg,${G.green}12,${G.blue}08)`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <span style={{fontSize:26}}>{SPORT_ICONS[w.type]||"ğŸ’ª"}</span>
                    <div>
                      <div style={{fontSize:14,fontWeight:800,color:G.text}}>{w.type}</div>
                      <div style={{display:"flex",gap:8,marginTop:2}}>
                        {w.duration>0 && <span style={{fontSize:11,color:G.green,fontWeight:700}}>â± {w.duration}ë¶„</span>}
                        {w.note && <span style={{fontSize:11,color:G.textMid}}>{w.note}</span>}
                      </div>
                    </div>
                  </div>
                  <div style={{display:"flex",gap:6}}>
                    <button onClick={()=>openEditWorkout(w)} style={{...navBtnStyle,width:28,height:28,fontSize:13}}>âœï¸</button>
                    <button onClick={()=>deleteWorkout(w.id)} style={{...navBtnStyle,width:28,height:28,background:"#FFF5F5",color:G.red}}>Ã—</button>
                  </div>
                </div>
                {w.sets.length>0 && (
                  <div style={{padding:"10px 16px 14px"}}>
                    <div style={{display:"grid",gridTemplateColumns:"1fr auto auto",gap:"4px 12px",fontSize:11,color:G.textLight,fontWeight:700,marginBottom:6,paddingBottom:4,borderBottom:`1px solid ${G.borderLight}`}}>
                      <span>ìš´ë™</span><span style={{textAlign:"right"}}>íšŸìˆ˜/ì„¸íŠ¸</span><span style={{textAlign:"right"}}>ì¤‘ëŸ‰</span>
                    </div>
                    {w.sets.map((s,i)=>(
                      <div key={i} style={{display:"grid",gridTemplateColumns:"1fr auto auto",gap:"3px 12px",padding:"5px 0",borderBottom:`1px solid ${G.borderLight}`,fontSize:13}}>
                        <span style={{fontWeight:600,color:G.text}}>{s.exercise}</span>
                        <span style={{color:G.blue,fontWeight:700,textAlign:"right"}}>{s.reps}</span>
                        <span style={{color:G.textMid,textAlign:"right"}}>{s.weight||"-"}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))
          )}
          <button onClick={openAddWorkout} style={{width:"100%",padding:"13px 0",borderRadius:16,border:`2px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ ìš´ë™ ê¸°ë¡ ì¶”ê°€</button>

          <div style={{marginTop:20}}>
            <div style={{fontSize:10,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:10}}>ì´ë²ˆ ë‹¬ ìš´ë™ í˜„í™©</div>
            <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
              {Array.from({length:getFirst(y,m)}).map((_,i)=>(<div key={`e${i}`} style={{width:32,height:32}}/>))}
              {Array.from({length:monthDays},(_,i)=>{
                const day=i+1;
                const k=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                const hasWorkout=(workoutLog[k]||[]).length>0;
                const count=(workoutLog[k]||[]).length;
                const isToday=k===TODAY_STR; const isSel=k===selStr;
                const dow=new Date(y,m,day).getDay();
                return (
                  <div key={day} onClick={()=>setSelectedDate(new Date(y,m,day))}
                    style={{width:32,height:32,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",
                      background:hasWorkout?`${G.green}${count>1?"dd":"88"}`:"#F7FAFC",
                      border:isSel?`2px solid ${G.green}`:isToday?`2px solid ${G.green}66`:`1px solid ${G.borderLight}`,
                      boxSizing:"border-box",flexDirection:"column",gap:1}}>
                    <span style={{fontSize:10,fontWeight:isSel?800:400,color:hasWorkout?"#fff":dow===0?G.red:dow===6?G.blue:G.textMid}}>{day}</span>
                    {hasWorkout&&count>1&&<span style={{fontSize:7,color:"rgba(255,255,255,0.85)",fontWeight:700}}>x{count}</span>}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {subTab==="weight" && (
        <div>
          <div style={{background:`linear-gradient(135deg,${G.blue}18,${G.green}10)`,borderRadius:20,padding:20,marginBottom:18,border:`1.5px solid ${G.blue}22`,textAlign:"center"}}>
            {todayWeight ? (
              <>
                <div style={{fontSize:11,color:G.textLight,fontWeight:700,marginBottom:4}}>ì˜¤ëŠ˜ ì²´ì¤‘</div>
                <div style={{fontSize:48,fontWeight:900,color:G.blue,letterSpacing:-2}}>{todayWeight}<span style={{fontSize:18,color:G.textMid,fontWeight:600}}>kg</span></div>
                {(()=>{
                  const yd=new Date(selectedDate); yd.setDate(yd.getDate()-1);
                  const pv=weightLog[ds(yd)];
                  if(!pv) return null;
                  const diff=(todayWeight-pv).toFixed(1);
                  return <div style={{fontSize:13,fontWeight:700,color:parseFloat(diff)<0?G.green:G.red,marginTop:4}}>{parseFloat(diff)>0?"+":""}{diff}kg ì „ë‚  ëŒ€ë¹„</div>;
                })()}
                <button onClick={()=>{setWForm(String(todayWeight));setShowWeightInput(true);}} style={{marginTop:12,padding:"6px 16px",borderRadius:12,background:"rgba(255,255,255,0.7)",border:`1px solid ${G.blue}33`,color:G.blue,fontSize:12,fontWeight:700,cursor:"pointer"}}>ìˆ˜ì •</button>
              </>
            ) : (
              <>
                <div style={{fontSize:36,marginBottom:8}}>âš–ï¸</div>
                <div style={{fontSize:13,color:G.textMid,marginBottom:12}}>ì˜¤ëŠ˜ ì²´ì¤‘ì„ ì…ë ¥í•´ë³´ì„¸ìš”</div>
                <button onClick={()=>setShowWeightInput(true)} style={{padding:"10px 24px",borderRadius:14,background:G.blue,color:"#fff",border:"none",fontWeight:700,fontSize:13,cursor:"pointer"}}>ì²´ì¤‘ ì…ë ¥</button>
              </>
            )}
          </div>

          {showWeightInput && (
            <div style={{background:"#fff",borderRadius:16,padding:16,marginBottom:16,border:`1.5px solid ${G.blue}44`,boxShadow:`0 4px 20px ${G.blue}18`}}>
              <div style={{fontSize:11,fontWeight:700,color:G.textLight,marginBottom:10}}>ì²´ì¤‘ ì…ë ¥ (kg)</div>
              <div style={{display:"flex",gap:8}}>
                <input type="number" step="0.1" value={wForm} onChange={e=>setWForm(e.target.value)}
                  placeholder="ì˜ˆ: 67.5" style={{...inp(),marginBottom:0,flex:1,fontSize:18,fontWeight:700,textAlign:"center"}} autoFocus/>
                <button onClick={saveWeight} style={{padding:"0 20px",borderRadius:12,background:G.blue,color:"#fff",border:"none",fontWeight:700,cursor:"pointer"}}>ì €ì¥</button>
                <button onClick={()=>{setShowWeightInput(false);setWForm("");}} style={{padding:"0 14px",borderRadius:12,background:"#F0F4F8",color:G.textMid,border:"none",fontWeight:700,cursor:"pointer"}}>ì·¨ì†Œ</button>
              </div>
            </div>
          )}

          <div style={{background:"#fff",borderRadius:18,padding:16,border:`1.5px solid ${G.border}`,marginBottom:16}}>
            <div style={{fontSize:11,fontWeight:700,color:G.textLight,marginBottom:14}}>ìµœê·¼ 14ì¼ ì²´ì¤‘ ì¶”ì´</div>
            <div style={{position:"relative",height:100,marginBottom:6}}>
              <div style={{position:"absolute",left:0,top:0,bottom:0,display:"flex",flexDirection:"column",justifyContent:"space-between"}}>
                <span style={{fontSize:9,color:G.textLight}}>{wMax.toFixed(1)}</span>
                <span style={{fontSize:9,color:G.textLight}}>{((wMax+wMin)/2).toFixed(1)}</span>
                <span style={{fontSize:9,color:G.textLight}}>{wMin.toFixed(1)}</span>
              </div>
              <div style={{marginLeft:28,height:"100%",display:"flex",alignItems:"flex-end",gap:3,borderBottom:`1px solid ${G.borderLight}`,borderLeft:`1px solid ${G.borderLight}`,paddingLeft:4}}>
                {last14Weight.map((d,i)=>{
                  const pct=d.val?Math.max(5,Math.round((d.val-wMin)/(wMax-wMin)*90)):0;
                  const isSel=d.date===selStr;
                  return (
                    <div key={i} onClick={()=>setSelectedDate(new Date(d.date))} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",cursor:"pointer",gap:2}}>
                      {d.val&&<span style={{fontSize:7,color:isSel?G.blue:G.textLight,fontWeight:isSel?800:400}}>{d.val}</span>}
                      <div style={{width:"100%",borderRadius:"3px 3px 0 0",background:d.val?(isSel?G.blue:`${G.blue}88`):"#EDF2F7",height:`${pct}px`,transition:"height 0.3s",minHeight:d.val?4:2}}/>
                    </div>
                  );
                })}
              </div>
            </div>
            <div style={{marginLeft:32,display:"flex",gap:3}}>
              {last14Weight.map((d,i)=>(<div key={i} style={{flex:1,textAlign:"center",fontSize:8,color:G.textLight}}>{i%2===0?d.label:""}</div>))}
            </div>
          </div>

          {wVals.length>1 && (
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
              {[
                {l:"ì‹œì‘",v:`${last14Weight.find(d=>d.val)?.val}kg`,c:G.textMid},
                {l:"ìµœì €",v:`${Math.min(...wVals)}kg`,c:G.green},
                {l:"ë³€í™”",v:`${(wVals[wVals.length-1]-wVals[0]).toFixed(1)}kg`,c:wVals[wVals.length-1]-wVals[0]<0?G.green:G.red},
              ].map(s=>(
                <div key={s.l} style={{background:"#fff",borderRadius:14,padding:"12px 10px",textAlign:"center",border:`1px solid ${G.border}`}}>
                  <div style={{fontSize:9,color:G.textLight,fontWeight:700,marginBottom:4}}>{s.l}</div>
                  <div style={{fontSize:15,fontWeight:900,color:s.c}}>{s.v}</div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {subTab==="diet" && (
        <div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
            <div style={{fontSize:12,fontWeight:700,color:G.textMid}}>ğŸ¥— ì˜¤ëŠ˜ ì‹ë‹¨</div>
            <button onClick={()=>setShowMealCatMgr(true)}
              style={{padding:"5px 12px",borderRadius:10,background:G.greenSoft,border:`1.5px solid ${G.greenMid}`,color:G.green,fontSize:11,fontWeight:700,cursor:"pointer"}}>
              âš™ï¸ ì¹´í…Œê³ ë¦¬ í¸ì§‘
            </button>
          </div>

          {mealCats.map(cat=>{
            const items = todayDiet.filter(d=>d.meal===cat.id);
            return (
              <div key={cat.id} style={{marginBottom:16}}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:7}}>
                  <div style={{width:28,height:28,borderRadius:8,background:G.greenSoft,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,border:`1px solid ${G.greenMid}`}}>{cat.icon}</div>
                  <span style={{fontSize:13,fontWeight:800,color:G.text}}>{cat.label}</span>
                  <span style={{fontSize:10,color:G.textLight,marginLeft:2}}>{items.length>0?`${items.length}ê°€ì§€`:""}</span>
                </div>

                {items.map(item=>(
                  <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:13,background:"#fff",border:`1px solid ${G.border}`,marginBottom:6,boxShadow:"0 1px 4px rgba(0,0,0,0.04)"}}>
                    <div style={{width:6,height:6,borderRadius:3,background:G.green,flexShrink:0}}/>
                    <div style={{flex:1,fontSize:13,fontWeight:500,color:G.text,lineHeight:1.4}}>{item.foods}</div>
                    <button onClick={()=>deleteDiet(item.id)} style={{width:22,height:22,borderRadius:11,background:"#FFF5F5",border:"none",cursor:"pointer",fontSize:11,color:G.red,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>Ã—</button>
                  </div>
                ))}

                {items.length===0 && (
                  <div style={{padding:"8px 14px",borderRadius:12,border:`1.5px dashed ${G.borderLight}`,color:"#CBD5E0",fontSize:12,marginBottom:6}}>ê¸°ë¡ ì—†ìŒ</div>
                )}

                <button onClick={()=>{setDForm({meal:cat.id,foods:""});setShowAddDiet(true);}}
                  style={{width:"100%",padding:"7px 0",borderRadius:11,border:`1.5px dashed ${G.greenMid}`,background:"transparent",color:G.green,fontSize:11,fontWeight:700,cursor:"pointer"}}>
                  + {cat.label} ì¶”ê°€
                </button>
              </div>
            );
          })}

          {mealCats.length===0 && (
            <div style={{textAlign:"center",padding:"24px 0",color:"#CBD5E0"}}>
              <div style={{fontSize:32,marginBottom:8}}>ğŸ½ï¸</div>
              <div style={{fontSize:13}}>ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
              <button onClick={()=>setShowMealCatMgr(true)} style={{marginTop:12,padding:"8px 20px",borderRadius:12,background:G.green,color:"#fff",border:"none",fontWeight:700,fontSize:12,cursor:"pointer"}}>+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
            </div>
          )}
        </div>
      )}

      <Modal show={showAddWorkout} onClose={()=>setShowAddWorkout(false)} title={editWorkoutId?"ìš´ë™ ìˆ˜ì •":"ìš´ë™ ê¸°ë¡ ì¶”ê°€"}>
        <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:14}}>
          {WORKOUT_TYPES.map(t=>(
            <button key={t} onClick={()=>setWoForm(f=>({...f,type:t}))}
              style={{padding:"6px 12px",borderRadius:20,border:`1.5px solid ${woForm.type===t?G.green:G.border}`,background:woForm.type===t?G.greenSoft:"#fff",color:woForm.type===t?G.green:G.textLight,fontSize:11,fontWeight:700,cursor:"pointer"}}>
              {SPORT_ICONS[t]||"ğŸ’ª"} {t}
            </button>
          ))}
        </div>
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          <div style={{flex:1}}>
            <div style={{fontSize:10,color:G.textLight,fontWeight:700,marginBottom:4}}>ìš´ë™ ì‹œê°„ (ë¶„)</div>
            <input type="number" value={woForm.duration} onChange={e=>setWoForm(f=>({...f,duration:e.target.value}))} placeholder="60" style={{...inp(),marginBottom:0}}/>
          </div>
          <div style={{flex:2}}>
            <div style={{fontSize:10,color:G.textLight,fontWeight:700,marginBottom:4}}>ë©”ëª¨</div>
            <input value={woForm.note} onChange={e=>setWoForm(f=>({...f,note:e.target.value}))} placeholder="ì˜¤ëŠ˜ ìš´ë™ ë…¸íŠ¸..." style={{...inp(),marginBottom:0}}/>
          </div>
        </div>
        <div style={{fontSize:10,color:G.textLight,fontWeight:700,marginBottom:8}}>ì„¸íŠ¸ ê¸°ë¡ (ì„ íƒ)</div>
        {woForm.sets.map((s,i)=>(
          <div key={i} style={{display:"grid",gridTemplateColumns:"1fr 80px 80px 28px",gap:6,marginBottom:8,alignItems:"center"}}>
            <input value={s.exercise} onChange={e=>updateSet(i,"exercise",e.target.value)} placeholder="ìš´ë™ëª…" style={{...inp(),marginBottom:0,fontSize:12}}/>
            <input value={s.reps} onChange={e=>updateSet(i,"reps",e.target.value)} placeholder="12x3" style={{...inp(),marginBottom:0,fontSize:12,textAlign:"center"}}/>
            <input value={s.weight} onChange={e=>updateSet(i,"weight",e.target.value)} placeholder="70kg" style={{...inp(),marginBottom:0,fontSize:12,textAlign:"center"}}/>
            <button onClick={()=>removeSet(i)} style={{width:28,height:36,borderRadius:8,background:"#FFF5F5",border:"none",cursor:"pointer",color:G.red,fontSize:14}}>Ã—</button>
          </div>
        ))}
        <button onClick={addSet} style={{width:"100%",padding:"8px 0",borderRadius:10,border:`1.5px dashed ${G.border}`,background:"transparent",color:G.textLight,fontSize:12,fontWeight:700,cursor:"pointer",marginBottom:16}}>+ ì„¸íŠ¸ ì¶”ê°€</button>
        <Btn variant="primary" style={{width:"100%"}} onClick={saveWorkout}>ì €ì¥</Btn>
      </Modal>

      <Modal show={showAddDiet} onClose={()=>setShowAddDiet(false)} title="ì‹ë‹¨ ì¶”ê°€">
        <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:14}}>
          {mealCats.map(c=>(
            <button key={c.id} onClick={()=>setDForm(f=>({...f,meal:c.id}))}
              style={{padding:"7px 14px",borderRadius:20,border:`1.5px solid ${dForm.meal===c.id?G.green:G.border}`,
                background:dForm.meal===c.id?G.greenSoft:"#fff",
                color:dForm.meal===c.id?G.green:G.textLight,fontSize:12,fontWeight:700,cursor:"pointer",display:"flex",alignItems:"center",gap:4}}>
              {c.icon} {c.label}
            </button>
          ))}
        </div>
        <input value={dForm.foods} onChange={e=>setDForm(f=>({...f,foods:e.target.value}))}
          placeholder="ìŒì‹ ì…ë ¥ (ì˜ˆ: ë‹­ê°€ìŠ´ì‚´, í˜„ë¯¸ë°¥, ë¸Œë¡œì½œë¦¬)" style={inp()} autoFocus
          onKeyDown={e=>e.key==="Enter"&&saveDiet()}/>
        <Btn variant="primary" style={{width:"100%"}} onClick={saveDiet}>ì €ì¥</Btn>
      </Modal>

      <Modal show={showMealCatMgr} onClose={()=>setShowMealCatMgr(false)} title="ì‹ë‹¨ ì¹´í…Œê³ ë¦¬ í¸ì§‘">
        {mealCats.map(c=>(
          <div key={c.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 0",borderBottom:`1px solid ${G.borderLight}`}}>
            <div style={{width:36,height:36,borderRadius:10,background:G.greenSoft,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,border:`1px solid ${G.greenMid}`,flexShrink:0}}>{c.icon}</div>
            <div style={{flex:1,fontSize:13,fontWeight:700,color:G.text}}>{c.label}</div>
            <Btn small variant="neutral" onClick={()=>openEditCat(c)}>âœï¸ ìˆ˜ì •</Btn>
            <Btn small variant="danger" onClick={()=>deleteCat(c.id)}>ì‚­ì œ</Btn>
          </div>
        ))}
        <div style={{marginTop:16,padding:16,background:G.bg,borderRadius:16,border:`1.5px solid ${G.border}`}}>
          <div style={{fontSize:11,fontWeight:700,color:G.textLight,letterSpacing:1,marginBottom:10}}>{editCatId?"ì¹´í…Œê³ ë¦¬ ìˆ˜ì •":"ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€"}</div>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            <input value={catMgrForm.icon} onChange={e=>setCatMgrForm(f=>({...f,icon:e.target.value}))}
              style={{...inp(),width:56,marginBottom:0,textAlign:"center",fontSize:22,padding:"8px"}} maxLength={2} placeholder="ğŸ½ï¸"/>
            <input value={catMgrForm.label} onChange={e=>setCatMgrForm(f=>({...f,label:e.target.value}))}
              style={{...inp(),flex:1,marginBottom:0}} placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„"
              onKeyDown={e=>e.key==="Enter"&&saveCat()}/>
          </div>
          <Btn variant="primary" style={{width:"100%"}} onClick={saveCat}>{editCatId?"ìˆ˜ì • ì €ì¥":"ì¶”ê°€"}</Btn>
          {editCatId && (
            <Btn variant="neutral" style={{width:"100%",marginTop:8}} onClick={()=>{setEditCatId(null);setCatMgrForm({label:"",icon:"ğŸ½ï¸"});}}>ì·¨ì†Œ</Btn>
          )}
        </div>
        <Btn variant="ghost" style={{width:"100%",marginTop:12}} onClick={()=>setShowMealCatMgr(false)}>ë‹«ê¸°</Btn>
      </Modal>
    </div>
  );
}

export default function App(){
  const [isMac, setIsMac] = useState(window.innerWidth >= 768);
  const [tab, setTab] = useState("monthly");
  const [currentDate, setCurrentDate] = useState(new Date(2026,1,1));
  const [selectedDate, setSelectedDate] = useState(TODAY);
  const [showCats, setShowCats] = useState(false);
  const [syncStatus, setSyncStatus] = useState("idle");
  const [lastSync, setLastSync] = useState(null);

  function manualSync(){
    setSyncStatus("syncing");
    document.dispatchEvent(new Event("visibilitychange"));
    setTimeout(()=>{ setSyncStatus("ok"); setLastSync(new Date()); setTimeout(()=>setSyncStatus("idle"),2500); }, 900);
  }

  const SyncBadge = () => {
    const fmt = d => d ? `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}` : "";
    const label = syncStatus==="syncing"?"â³ ë™ê¸°í™” ì¤‘...":syncStatus==="ok"?`âœ… ${fmt(lastSync)} ë™ê¸°í™”ë¨`:"â˜ï¸ ë™ê¸°í™”";
    const color = syncStatus==="syncing"?G.yellow:syncStatus==="ok"?G.green:G.textMid;
    return (
      <button onClick={manualSync} title="ì§€ê¸ˆ ë™ê¸°í™”"
        style={{padding:"6px 12px",borderRadius:10,
          background:syncStatus==="ok"?G.greenSoft:"#F0F4F8",
          border:`1.5px solid ${syncStatus==="ok"?G.greenMid:G.border}`,
          color,fontSize:11,fontWeight:700,cursor:"pointer",transition:"all 0.3s",
          opacity:syncStatus==="syncing"?0.7:1}}>
        {label}
      </button>
    );
  };

  const [cats, setCats]               = usePersist("planner:cats",        DEFAULT_CATS);
  const [timeblocks, setTimeblocks]   = usePersist("planner:timeblocks",  DEFAULT_TB);
  const [tasks, setTasks]             = usePersist("planner:tasks",       DEFAULT_TASKS);
  const [weeklyGoals, setWeeklyGoals] = usePersist("planner:weeklyGoals", DEFAULT_WG);
  const [readingLog, setReadingLog]   = usePersist("planner:readingLog",  DEFAULT_READING);
  const [habits, setHabits]           = usePersist("planner:habits",      DEFAULT_HABITS);
  const [habitLog, setHabitLog]       = usePersist("planner:habitLog",    DEFAULT_HABIT_LOG);
  const [budget, setBudget]           = usePersist("planner:budget",      DEFAULT_BUDGET);
  const [weightLog, setWeightLog]     = usePersist("planner:weightLog",   DEFAULT_WEIGHT_LOG);
  const [dietLog, setDietLog]         = usePersist("planner:dietLog",     DEFAULT_DIET_LOG);
  const [workoutLog, setWorkoutLog]   = usePersist("planner:workoutLog",  DEFAULT_WORKOUT_LOG);
  const [mealCats, setMealCats]       = usePersist("planner:mealCats",    DEFAULT_MEAL_CATS);

  useEffect(()=>{
    const fn=()=>setIsMac(window.innerWidth>=768);
    window.addEventListener("resize",fn);
    return ()=>window.removeEventListener("resize",fn);
  },[]);

  const TABS = [
    {k:"monthly",icon:"ğŸ“…",l:"ì›”ê°„"},
    {k:"weekly", icon:"ğŸ“‹",l:"ì£¼ê°„"},
    {k:"daily",  icon:"âœ…",l:"ì¼ê°„"},
    {k:"habit",  icon:"ğŸ”¥",l:"ìŠµê´€"},
    {k:"budget", icon:"ğŸ’°",l:"ê°€ê³„ë¶€"},
    {k:"health", icon:"ğŸ’ª",l:"ê±´ê°•"},
  ];

  const renderContent = () => {
    switch(tab){
      case "monthly": return <MonthlyView isMac={isMac} currentDate={currentDate} setCurrentDate={setCurrentDate} selectedDate={selectedDate} setSelectedDate={setSelectedDate} timeblocks={timeblocks} setTimeblocks={setTimeblocks} readingLog={readingLog} cats={cats} tasks={tasks} budget={budget} weeklyGoals={weeklyGoals} workoutLog={workoutLog} setTab={setTab}/>;
      case "weekly":  return <WeeklyView selectedDate={selectedDate} setSelectedDate={setSelectedDate} tasks={tasks} setTasks={setTasks} weeklyGoals={weeklyGoals} setWeeklyGoals={setWeeklyGoals} readingLog={readingLog} cats={cats}/>;
      case "daily":   return <DailyView selectedDate={selectedDate} setSelectedDate={setSelectedDate} tasks={tasks} setTasks={setTasks} timeblocks={timeblocks} readingLog={readingLog} setReadingLog={setReadingLog} cats={cats}/>;
      case "habit":   return <HabitView selectedDate={selectedDate} setSelectedDate={setSelectedDate} habits={habits} setHabits={setHabits} habitLog={habitLog} setHabitLog={setHabitLog}/>;
      case "budget":  return <BudgetView selectedDate={selectedDate} setSelectedDate={setSelectedDate} budget={budget} setBudget={setBudget}/>;
      case "health":  return <HealthView selectedDate={selectedDate} setSelectedDate={setSelectedDate} weightLog={weightLog} setWeightLog={setWeightLog} dietLog={dietLog} setDietLog={setDietLog} workoutLog={workoutLog} setWorkoutLog={setWorkoutLog} mealCats={mealCats} setMealCats={setMealCats}/>;
      default: return null;
    }
  };

  if(isMac){
    return (
      <div style={{minHeight:"100vh",background:"linear-gradient(135deg,#E8F5EF 0%,#F5F9FF 100%)",fontFamily:"-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif"}}>
        <div style={{background:"#fff",borderBottom:`1px solid ${G.border}`,padding:"0 40px",display:"flex",alignItems:"center",justifyContent:"space-between",height:60,boxShadow:"0 1px 8px rgba(0,0,0,0.05)"}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{width:32,height:32,borderRadius:10,background:G.green,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>ğŸŒ¿</div>
            <span style={{fontWeight:900,fontSize:20,color:G.text,letterSpacing:-0.5}}>My Planner</span>
          </div>
          <div style={{display:"flex",gap:6}}>
            {TABS.map(t=>(<button key={t.k} onClick={()=>setTab(t.k)} style={{padding:"8px 16px",borderRadius:12,border:"none",cursor:"pointer",fontSize:12,fontWeight:700,background:tab===t.k?G.green:"#F0F4F8",color:tab===t.k?"#fff":G.textMid,boxShadow:tab===t.k?`0 3px 10px ${G.green}44`:"none",transition:"all 0.2s"}}>{t.icon} {t.l}</button>))}
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <SyncBadge/>
            <button onClick={()=>setShowCats(true)} style={{padding:"8px 16px",borderRadius:12,background:G.greenSoft,border:`1.5px solid ${G.greenMid}`,color:G.green,fontSize:13,fontWeight:700,cursor:"pointer"}}>ğŸ·ï¸ ì¹´í…Œê³ ë¦¬</button>
          </div>
        </div>
        <div style={{maxWidth:1100,margin:"0 auto",padding:"30px 40px",display:"grid",gridTemplateColumns:tab==="monthly"?"1fr 340px":"1fr",gap:24}}>
          {tab==="monthly" ? (
            <>
              <div style={{background:"#fff",borderRadius:24,padding:28,boxShadow:"0 4px 20px rgba(0,0,0,0.06)",border:`1px solid ${G.border}`,display:"flex",flexDirection:"column",minHeight:"calc(100vh - 140px)"}}>{renderContent()}</div>
              <div style={{background:"#fff",borderRadius:24,padding:24,boxShadow:"0 4px 20px rgba(0,0,0,0.06)",border:`1px solid ${G.border}`,overflowY:"auto",maxHeight:"calc(100vh - 120px)"}}>
                <div style={{color:G.textLight,fontSize:10,letterSpacing:1.5,textTransform:"uppercase",fontWeight:700,marginBottom:12}}>{selectedDate.getDate()}ì¼ ë…ì„œ ê¸°ë¡</div>
                <ReadingLogEntry dateStr={ds(selectedDate)} readingLog={readingLog} setReadingLog={setReadingLog}/>
              </div>
            </>
          ) : (
            <div style={{background:"#fff",borderRadius:24,padding:28,boxShadow:"0 4px 20px rgba(0,0,0,0.06)",border:`1px solid ${G.border}`,maxWidth:760}}>{renderContent()}</div>
          )}
        </div>
        {showCats && (
          <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(8px)",zIndex:200}} onClick={()=>setShowCats(false)}>
            <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:24,padding:28,width:440,maxHeight:"80vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,0.15)"}}>
              <CatsManager cats={cats} setCats={setCats} onClose={()=>setShowCats(false)}/>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div style={{minHeight:"100vh",background:"linear-gradient(135deg,#E8F5EF,#F5F9FF)",display:"flex",justifyContent:"center",alignItems:"flex-start",paddingTop:24,paddingBottom:40,fontFamily:"-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif"}}>
      <div style={{width:390,background:G.bg,borderRadius:50,overflow:"hidden",minHeight:844,boxShadow:"0 40px 100px rgba(0,0,0,0.12),0 0 0 1px rgba(255,255,255,0.9)",position:"relative",border:"1px solid rgba(0,0,0,0.04)",display:"flex",flexDirection:"column"}}>
        <div style={{background:"#fff",padding:"14px 28px 0",display:"flex",justifyContent:"space-between",color:G.text,fontSize:14,fontWeight:700}}>
          <span>9:41</span>
          <div style={{width:120,height:30,background:"#1A202C",borderRadius:20,position:"absolute",left:"50%",transform:"translateX(-50%)",top:0}}/>
          <span>â—â—â—</span>
        </div>
        <div style={{background:"#fff",padding:"16px 22px 0",borderBottom:`1px solid ${G.borderLight}`}}>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4}}>
            <div>
              <div style={{color:G.textLight,fontSize:9,letterSpacing:3,textTransform:"uppercase",fontWeight:800}}>MY PLANNER</div>
              <div style={{color:G.text,fontSize:22,fontWeight:900,letterSpacing:-0.5}}>
                {tab==="monthly"&&`${currentDate.getFullYear()}ë…„ ${MONTHS_KO[currentDate.getMonth()]}`}
                {tab==="weekly"&&(()=>{ const wd2=getWeekDates(selectedDate); return `${wd2[0].getMonth()+1}.${String(wd2[0].getDate()).padStart(2,"0")}~${wd2[6].getMonth()+1}.${String(wd2[6].getDate()).padStart(2,"0")}`; })()}
                {tab==="daily"&&`${selectedDate.getMonth()+1}ì›” ${selectedDate.getDate()}ì¼`}
                {tab==="habit"&&"ìŠµê´€ íŠ¸ë˜ì»¤"}
                {tab==="budget"&&"ê°€ê³„ë¶€"}
                {tab==="health"&&"ê±´ê°• ê¸°ë¡"}
              </div>
            </div>
            <div style={{display:"flex",gap:6,alignItems:"center"}}>
              <SyncBadge/>
              <button onClick={()=>setShowCats(true)} style={{width:36,height:36,borderRadius:12,background:G.greenSoft,border:`1.5px solid ${G.greenMid}`,cursor:"pointer",fontSize:16}}>ğŸ·ï¸</button>
            </div>
          </div>
          <div style={{display:"flex",gap:0,overflowX:"auto",scrollbarWidth:"none"}}>
            {TABS.map(t=>(
              <button key={t.k} onClick={()=>setTab(t.k)} style={{flexShrink:0,padding:"10px 12px",background:"transparent",border:"none",cursor:"pointer",fontSize:11,fontWeight:700,color:tab===t.k?G.green:G.textLight,borderBottom:`2.5px solid ${tab===t.k?G.green:"transparent"}`,transition:"all 0.2s",whiteSpace:"nowrap"}}>
                {t.icon} {t.l}
              </button>
            ))}
          </div>
        </div>

        {/* ì½˜í…ì¸  ì˜ì—­ â€” flex:1ë¡œ ë‚¨ì€ ê³µê°„ ì „ë¶€ ì°¨ì§€ */}
        <div style={{
          flex:1,
          minHeight:0,
          overflowY: tab==="monthly" ? "hidden" : "auto",
          overflowX:"hidden",
          background:G.bg,
          padding: tab==="monthly" ? "10px 10px 0" : "18px 18px 0",
          display:"flex",
          flexDirection:"column",
        }}>
          {renderContent()}
        </div>

        {/* ë°”í…€ íƒ­ â€” flex itemìœ¼ë¡œ í•­ìƒ í•˜ë‹¨ì— ë”± ë¶™ìŒ */}
        <div style={{
          flexShrink:0,
          padding:"6px 0 20px",
          background:"rgba(255,255,255,0.97)",
          backdropFilter:"blur(20px)",
          borderTop:`1px solid ${G.borderLight}`,
          display:"flex",
          justifyContent:"space-around",
          boxShadow:"0 -4px 20px rgba(0,0,0,0.05)",
        }}>
          {TABS.map(item=>(
            <button key={item.k} onClick={()=>setTab(item.k)} style={{background:"transparent",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:2}}>
              <div style={{width:36,height:28,borderRadius:10,background:tab===item.k?G.greenSoft:"transparent",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s"}}><span style={{fontSize:16}}>{item.icon}</span></div>
              <span style={{fontSize:8,color:tab===item.k?G.green:"#A0AEC0",fontWeight:800,letterSpacing:0.3}}>{item.l}</span>
            </button>
          ))}
        </div>
      </div>
      {showCats && (
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"flex-end",backdropFilter:"blur(8px)",zIndex:200}} onClick={()=>setShowCats(false)}>
          <div onClick={e=>e.stopPropagation()} style={{width:"100%",background:"#fff",borderRadius:"24px 24px 0 0",padding:24,paddingBottom:40,maxHeight:"88vh",overflowY:"auto"}}>
            <div style={{width:36,height:4,background:G.border,borderRadius:2,margin:"0 auto 16px"}}/>
            <CatsManager cats={cats} setCats={setCats} onClose={()=>setShowCats(false)}/>
          </div>
        </div>
      )}
    </div>
  );
}


const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
  </script>
</body>
</html>
